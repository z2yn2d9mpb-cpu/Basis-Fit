<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Basis Fit"/>
<meta name="theme-color" content="#1B2735" id="theme-color-meta"/>

<!-- SEO Meta Tags -->
<meta name="description" content="Basis-Fit Workout Tracker - Houd je trainingen, schema's en persoonlijke records bij. Sync tussen apparaten, deel je workouts en bereik je fitness doelen."/>
<meta name="keywords" content="workout tracker, fitness app, training schema, PR tracking, basis-fit, gym tracker"/>
<meta name="author" content="Basis-Fit Tracker"/>

<!-- Open Graph / Social Media -->
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://basis-fit.vercel.app/"/>
<meta property="og:title" content="Basis-Fit Workout Tracker"/>
<meta property="og:description" content="Houd je trainingen, schema's en persoonlijke records bij. Sync tussen apparaten en bereik je fitness doelen."/>
<meta property="og:site_name" content="Basis-Fit Tracker"/>

<!-- Twitter Card -->
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Basis-Fit Workout Tracker"/>
<meta name="twitter:description" content="Jouw persoonlijke workout tracker voor het bijhouden van trainingen en PR's."/>

<title>Basis Fit - Workout Tracker</title>

<!-- Preconnect for faster font loading -->
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --navy:#1B2735; --navy2:#23395B;
  --accent:#4A90D9; --ag:rgba(74,144,217,.13);
  --w:#fff; --off:#F4F6FA; --g100:#EAEDF4; --g200:#D2D8E6; --g400:#96A3B8; --g600:#5C6B82;
  --green:#27C47A; --greenbg:rgba(39,196,122,.1);
  --gold:#F5A623; --goldbg:rgba(245,166,35,.12);
  --red:#E8453C; --redbg:rgba(232,69,60,.1);
  --r:16px; --rsm:10px; --rcard:14px;
  --safe-t:env(safe-area-inset-top,0px); --safe-b:env(safe-area-inset-bottom,0px);
  --sh:0 2px 12px rgba(27,39,53,.08);
}

/* Dark mode color overrides */
[data-theme="dark"] {
  --w:#1a1f2e;
  --off:#0f1419;
  --g100:#242b3d;
  --g200:#2d3548;
  --g400:#8b92a8;
  --g600:#b4b9c8;
  --sh:0 2px 12px rgba(0,0,0,.3);
}

/* Global dark mode text fixes */
[data-theme="dark"] input::placeholder {
  color:rgba(255,255,255,0.3);
}
[data-theme="dark"] select {
  color:#e8ecf2;
}
[data-theme="dark"] textarea {
  color:#e8ecf2;
}


*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--off);color:var(--navy);font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased;overscroll-behavior:none;transition:background-color 0.3s ease, color 0.3s ease}

/* Dark mode text colors */
[data-theme="dark"] {
  color:#e8ecf2;
}

/* Comprehensive dark mode text fixes - catch all */
[data-theme="dark"] .prog-name,
[data-theme="dark"] .wk-day,
[data-theme="dark"] .ex-name,
[data-theme="dark"] .hist-name,
[data-theme="dark"] .hist-iname,
[data-theme="dark"] .pr-ex,
[data-theme="dark"] .set-name,
[data-theme="dark"] .modal-title,
[data-theme="dark"] .topbar h2,
[data-theme="dark"] .aw-ex-name,
[data-theme="dark"] .hist-d-name,
[data-theme="dark"] .wk-stat-val,
[data-theme="dark"] .minp,
[data-theme="dark"] .aw-inp,
[data-theme="dark"] .set-dd,
[data-theme="dark"] h1,
[data-theme="dark"] h2,
[data-theme="dark"] h3,
[data-theme="dark"] h4 {
  color: #e8ecf2 !important;
}

/* Settings and other button text */
[data-theme="dark"] .mbtn-cancel,
[data-theme="dark"] .aw-btn-prev {
  color: #e8ecf2 !important;
}

/* Ensure ex-num is visible */
[data-theme="dark"] .ex-num {
  color: #e8ecf2 !important;
}


#app{max-width:430px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column;position:relative}
.screen{display:none;flex-direction:column;flex:1;min-height:0}
.screen.active{display:flex}
.scroll-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.scroll-body::-webkit-scrollbar{width:0}
/* Extra bottom padding so content never hides behind tabbar + safe area */
.pad{padding:14px 14px calc(32px + env(safe-area-inset-bottom,0px))}
/* Only clamp text nodes, not layout containers */
.ex-name,.wk-day,.prog-name,.hist-name,.hist-iname,.greet-name{word-break:break-word}

/* ── THEME TOGGLE ── */
.theme-toggle{background:transparent;border:none;padding:8px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;border-radius:8px;
  transition:background 0.2s;margin-right:4px}
.theme-toggle:hover{background:var(--g100)}
.theme-toggle svg{width:20px;height:20px;fill:var(--g600);transition:fill 0.2s}
[data-theme="dark"] .theme-toggle svg{fill:var(--g400)}

/* Theme selector modal */
.theme-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);
  display:none;align-items:center;justify-content:center;z-index:9999;
  animation:fadeIn 0.2s ease}
.theme-modal.show{display:flex}
.theme-panel{background:var(--w);border-radius:16px;padding:20px;
  width:calc(100% - 40px);max-width:320px;box-shadow:0 8px 32px rgba(0,0,0,0.2);
  animation:slideUp 0.3s ease;transition:background 0.3s}
h3{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;
  margin-bottom:16px;color:var(--navy);transition:color 0.3s}
[data-theme="dark"] h3{color:#e8ecf2}
.theme-options{display:flex;flex-direction:column;gap:8px}
.theme-option{background:transparent;border:2px solid var(--g100);
  border-radius:12px;padding:14px 16px;cursor:pointer;
  display:flex;align-items:center;gap:12px;transition:all 0.2s;
  font-family:'DM Sans',sans-serif;font-size:15px;font-weight:500;
  color:var(--navy)}
[data-theme="dark"] .theme-option{color:#e8ecf2;border-color:var(--g100)}
.theme-option:hover{background:var(--g100)}
.theme-option.active{border-color:var(--accent);background:var(--ag)}
.theme-option svg{width:22px;height:22px;fill:var(--g600);flex-shrink:0;transition:fill 0.2s}
[data-theme="dark"] .theme-option svg{fill:var(--g400)}
.theme-option.active svg{fill:var(--accent)}
.theme-option-text{flex:1}
.theme-option-label{display:block;font-weight:600;margin-bottom:2px}
.theme-option-desc{display:block;font-size:12px;color:var(--g400);font-weight:400;transition:color 0.3s}
.theme-close{background:var(--g100);border:none;border-radius:10px;
  padding:12px 24px;margin-top:16px;width:100%;cursor:pointer;
  font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;
  color:var(--navy);transition:all 0.2s}
[data-theme="dark"] .theme-close{color:#e8ecf2}
.theme-close:hover{background:var(--g200)}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}


/* ── TOP BAR ── */
.topbar{background:var(--w);padding:calc(12px + var(--safe-t)) 16px 12px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--g100);flex-shrink:0;
  box-shadow:0 1px 8px rgba(27,39,53,.05);gap:8px;transition:background 0.3s, border-color 0.3s, box-shadow 0.3s}
[data-theme="dark"] .topbar{box-shadow:0 1px 8px rgba(0,0,0,.2)}
.tb-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.tb-right{display:flex;align-items:center;gap:4px;flex-shrink:0}
.tb-logo{width:32px;height:32px;background:var(--navy);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.tb-logo svg{width:17px;height:17px;fill:#fff}
h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;letter-spacing:-.2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--navy);transition:color 0.3s}
[data-theme="dark"] h2{color:#e8ecf2}
.topbar-right{font-size:13px;color:var(--g400);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px;transition:color 0.3s}

/* ── TAB BAR ── */
.tabbar{display:flex;background:var(--w);border-top:1px solid var(--g100);
  padding:6px 8px calc(6px + var(--safe-b));gap:2px;flex-shrink:0;transition:background 0.3s, border-color 0.3s}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;
  padding:8px 4px;border:none;background:transparent;border-radius:var(--rsm);
  cursor:pointer;color:var(--g400);font-family:'DM Sans',sans-serif;
  font-size:10px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;
  transition:color .18s,background .18s;line-height:1}
.tab svg{width:19px;height:19px;fill:currentColor;flex-shrink:0}
.tab.active{color:var(--navy);background:var(--g100)}
[data-theme="dark"] .tab.active{color:#e8ecf2}

/* ── AUTH / ONBOARDING ── */
#scr-onboard{background:var(--navy);overflow-y:auto;-webkit-overflow-scrolling:touch}
.auth-wrap{min-height:100dvh;display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:calc(52px + var(--safe-t)) 28px calc(40px + var(--safe-b));gap:0}
.ob-icon{width:76px;height:76px;background:var(--accent);border-radius:20px;
  display:flex;align-items:center;justify-content:center;margin-bottom:20px;
  box-shadow:0 0 56px rgba(74,144,217,.5)}
.ob-icon svg{width:40px;height:40px;fill:#fff}
.ob-title{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;color:#fff;letter-spacing:-1px;margin-bottom:6px}
.ob-sub{color:var(--g400);font-size:14px;margin-bottom:32px;text-align:center}
/* Google button */
.btn-google{width:100%;background:#fff;color:#1a1a2e;border:none;
  border-radius:var(--rsm);padding:15px 20px;font-family:'DM Sans',sans-serif;
  font-size:15px;font-weight:600;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:10px;
  box-shadow:0 4px 18px rgba(0,0,0,.25);transition:transform .12s,opacity .12s;margin-bottom:16px}
.btn-google:active{transform:scale(.97);opacity:.9}
.btn-google img{width:20px;height:20px}
/* Auth tabs */
.auth-tabs{display:flex;background:rgba(255,255,255,.07);border-radius:10px;padding:3px;
  margin-bottom:16px;width:100%}
.auth-tab{flex:1;padding:9px;border:none;background:transparent;border-radius:8px;
  color:rgba(255,255,255,.5);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;
  cursor:pointer;transition:all .2s}
.auth-tab.active{background:rgba(255,255,255,.12);color:#fff}
.auth-form-panel{display:none;width:100%;flex-direction:column;gap:10px}
.auth-form-panel.active{display:flex}
.auth-divider{display:flex;align-items:center;gap:12px;margin:4px 0}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.1)}
.auth-divider span{color:rgba(255,255,255,.3);font-size:12px;font-weight:600}
.auth-switch{color:rgba(255,255,255,.4);font-size:13px;text-align:center;margin-top:8px}
.auth-switch button{background:none;border:none;color:var(--accent);font-family:'DM Sans',sans-serif;
  font-size:13px;font-weight:600;cursor:pointer;padding:0}
.auth-err{background:rgba(232,69,60,.15);border:1px solid rgba(232,69,60,.3);border-radius:8px;
  padding:10px 14px;color:#ff7b75;font-size:13px;font-weight:500;display:none;text-align:center}
.auth-err.show{display:block}
.flbl{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--g400);transition:color 0.3s;margin-bottom:6px;display:block}
.inp-dark{width:100%;background:rgba(255,255,255,.07);border:1.5px solid rgba(255,255,255,.1);
  border-radius:var(--rsm);padding:14px 16px;color:#fff;
  font-family:'DM Sans',sans-serif;font-size:16px;font-weight:500;outline:none;
  transition:border-color .2s,background .2s}
.inp-dark:focus{border-color:var(--accent);background:rgba(74,144,217,.08)}
.inp-dark::placeholder{color:rgba(255,255,255,.2)}
.btn-primary{width:100%;background:var(--accent);color:#fff;border:none;
  border-radius:var(--rsm);padding:16px;font-family:'DM Sans',sans-serif;
  font-size:16px;font-weight:600;cursor:pointer;
  box-shadow:0 4px 18px rgba(74,144,217,.4);transition:transform .12s,opacity .12s}
.btn-primary:active{transform:scale(.97);opacity:.9}
.btn-primary:disabled{opacity:.5;pointer-events:none}
/* Loading screen */
#scr-loading{background:var(--navy);align-items:center;justify-content:center;gap:16px}
.loading-logo{width:64px;height:64px;background:var(--accent);border-radius:18px;
  display:flex;align-items:center;justify-content:center;
  animation:loadPulse 1.5s ease infinite;box-shadow:0 0 40px rgba(74,144,217,.4)}
.loading-logo svg{width:34px;height:34px;fill:#fff}
@keyframes loadPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(.93);opacity:.7}}
.loading-txt{color:rgba(255,255,255,.4);font-size:13px;font-weight:600}
/* Sync indicator */
/* Sync indicator - hidden */
.sync-dot{display:none}

/* ── SECTION LABEL ── */
.slbl{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--g400);margin-bottom:10px;display:block}
[data-theme="dark"] .slbl{color:var(--g400)}

/* ── GREETING CARD ── */
.greet-card{border-radius:var(--r);padding:18px 20px;margin-bottom:16px;
  background:linear-gradient(135deg,var(--navy) 60%,var(--navy2))}
.greet-name{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:#fff;letter-spacing:-.3px}
.greet-sub-old{display:none}

/* ── PROGRAM CARDS ── */
.prog-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
.prog-card{background:var(--w);border-radius:var(--rcard);padding:15px 16px;
  display:flex;align-items:center;gap:12px;
  border:2px solid transparent;box-shadow:var(--sh);
  cursor:pointer;transition:border-color .15s,box-shadow .15s,transform .1s;user-select:none}
.prog-card:active{transform:scale(.98)}
.prog-card.sel{border-color:var(--accent);box-shadow:0 0 0 4px var(--ag),var(--sh)}
.prog-card.custom-prog{border-color:var(--g200);border-style:dashed}
.prog-card.custom-prog.sel{border-style:solid}
.prog-emoji{width:46px;height:46px;background:var(--g100);border-radius:12px;
  display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
.prog-info{flex:1;min-width:0}
.prog-name{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.prog-meta{font-size:12px;color:var(--g400);transition:color 0.3s}
[data-theme="dark"] .prog-name{color:#e8ecf2;margin-top:2px}
.prog-actions{display:flex;align-items:center;gap:0;flex-shrink:0}
.icon-btn{background:none;border:none;padding:7px;cursor:pointer;border-radius:8px;
  color:var(--g400);transition:color .15s,background .15s;display:flex;align-items:center}
.icon-btn:hover{background:var(--redbg);color:var(--red)}
.icon-btn svg{width:16px;height:16px;fill:currentColor;display:block}

/* ── ACTION BUTTONS ── */
.btn-row{display:flex;gap:10px;margin-bottom:12px}
.btn-outline{flex:1;background:transparent;color:var(--g600);border:1.5px solid var(--g200);
  border-radius:var(--rcard);padding:14px 10px;font-family:'DM Sans',sans-serif;
  font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;
  justify-content:center;gap:7px;transition:border-color .15s,color .15s,background .15s}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);background:var(--ag)}
.btn-outline:active{transform:scale(.97)}
.btn-outline svg{width:16px;height:16px;fill:currentColor}
.btn-start{width:100%;background:var(--navy);color:#fff;border:none;
  border-radius:var(--rcard);padding:18px;font-family:'Syne',sans-serif;
  font-size:17px;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  box-shadow:0 6px 20px rgba(27,39,53,.2);letter-spacing:-.2px;transition:transform .12s,opacity .12s}
.btn-start:active{transform:scale(.97);opacity:.92}
.btn-start svg{width:20px;height:20px;fill:#fff}

/* ── WORKOUT HEADER ── */
.wk-hd{border-radius:var(--r);padding:16px 18px;
  display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
  background:linear-gradient(135deg,var(--navy) 60%,var(--navy2))}
.wk-left{flex:1;min-width:0}
.wk-day{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:#fff;letter-spacing:-.3px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wk-date{font-size:12px;color:rgba(255,255,255,.4);margin-top:3px}
.ring{position:relative;width:52px;height:52px;flex-shrink:0;margin-left:12px}
.ring svg{transform:rotate(-90deg)}
.ring-t{fill:none;stroke:rgba(255,255,255,.12);stroke-width:3.5}
.ring-f{fill:none;stroke:var(--accent);stroke-width:3.5;stroke-linecap:round;transition:stroke-dashoffset .4s}
.ring-txt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:#fff}

/* ── EXERCISE CARD ── */
.ex-card{background:var(--w);border-radius:var(--rcard);overflow:hidden;
  box-shadow:var(--sh);margin-bottom:10px;transition:background 0.3s,box-shadow 0.3s,opacity .3s}
.ex-card.all-done{opacity:.5}
.ex-head{padding:13px 14px 8px;display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
.ex-name{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;line-height:1.2}
.ex-sub{font-size:12px;color:var(--g400);margin-top:3px}
.pr-badge{background:var(--goldbg);color:var(--gold);border:1px solid rgba(245,166,35,.3);
  border-radius:20px;padding:4px 9px;font-size:11px;font-weight:700;
  display:none;align-items:center;gap:3px;flex-shrink:0;white-space:nowrap;margin-top:2px}
.pr-badge.show{display:flex;animation:pop .25s ease}

/* ── SET ROWS ── */
.set-rows{padding:0 14px 8px;display:flex;flex-direction:column;gap:6px}
.set-row{display:flex;align-items:center;gap:6px}
.set-num{font-size:11px;font-weight:700;color:var(--g400);transition:color 0.3s;font-family:'DM Mono',monospace;
  width:22px;text-align:center;flex-shrink:0}

/* ── SET DROPDOWNS ── */
.set-dd-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  background:var(--g100);border-radius:10px;padding:5px 6px;border:1.5px solid transparent;
  transition:border-color .15s,background .15s;min-width:0}
.set-dd-wrap.active-field{border-color:var(--accent);background:var(--ag)}
.set-dd{width:100%;background:transparent;border:none;outline:none;
  font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--navy);transition:color 0.3s}
[data-theme="dark"] .set-dd{color:#e8ecf2;
  text-align:center;cursor:pointer;padding:4px 0;appearance:none;-webkit-appearance:none}
.set-dd option{background:var(--w);color:var(--navy);transition:background 0.3s, color 0.3s}
[data-theme="dark"] .set-dd option{background:var(--w);color:#e8ecf2;font-size:14px}
.set-dd-unit{font-size:10px;font-weight:700;color:var(--g400);transition:color 0.3s;letter-spacing:.06em;text-transform:uppercase;pointer-events:none}

/* ── REST TIMER ── */
.rest-timer{position:fixed;bottom:calc(70px + var(--safe-b) + 10px);left:50%;
  transform:translateX(-50%) scale(.88);background:var(--navy);color:#fff;
  padding:10px 18px 10px 14px;border-radius:40px;font-size:14px;font-weight:600;
  opacity:0;transition:opacity .25s,transform .25s;z-index:790;
  white-space:nowrap;box-shadow:0 8px 32px rgba(27,39,53,.3);pointer-events:none;
  display:flex;align-items:center;gap:10px;
  max-width:calc(100vw - 32px)}
.rest-timer.show{opacity:1;transform:translateX(-50%) scale(1);animation:timerIn .3s cubic-bezier(.34,1.4,.64,1) forwards}
.rest-timer-bar{width:80px;height:4px;background:rgba(255,255,255,.2);border-radius:2px;overflow:hidden}
.rest-timer-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .9s linear}

/* ── WORKOUT STATS MINI CARD ── */
.wk-stats{display:flex;gap:8px;margin-bottom:12px}
.wk-stat{flex:1;background:var(--w);border-radius:var(--rcard);padding:12px 10px;
  text-align:center;box-shadow:var(--sh)}
.wk-stat-val{font-family:'DM Mono',monospace;font-size:18px;font-weight:500;color:var(--navy);transition:color 0.3s}
[data-theme="dark"] .wk-stat-val{color:#e8ecf2}
.wk-stat-lbl{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--g400);transition:color 0.3s;margin-top:2px}

/* ── HOLD-TO-CHANGE indicator (kept for compat) ── */
.step-btn.holding{background:rgba(74,144,217,.15)}

.set-ck{width:40px;height:44px;border-radius:10px;border:2px solid var(--g200);
  background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;flex-shrink:0}
.set-ck svg{width:16px;height:16px;stroke:transparent;fill:none;stroke-width:2.5;
  stroke-linecap:round;stroke-linejoin:round;transition:stroke .15s}
.set-ck.done{background:var(--green);border-color:var(--green)}
.set-ck.done svg{stroke:#fff}

.prev-rec{padding:8px 14px;background:var(--g100);font-size:12px;color:var(--g600);
  display:flex;align-items:center;gap:5px;border-top:1px solid var(--g200)}
.prev-rec b{color:var(--navy);font-family:'DM Mono',monospace;font-weight:500}

/* ── OPEN TRAINING: add exercise panel ── */
.add-ex-panel{background:var(--w);border-radius:var(--rcard);padding:14px;box-shadow:var(--sh);margin-bottom:10px}
.add-ex-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:10px;color:var(--navy)}
.add-ex-row{display:flex;gap:8px;align-items:stretch}
.msel{flex:1;background:var(--g100);border:1.5px solid transparent;border-radius:9px;
  padding:12px 10px;color:var(--navy);font-family:'DM Sans',sans-serif;
  font-size:14px;font-weight:500;outline:none;cursor:pointer;transition:border-color .15s}
.msel:focus{border-color:var(--accent)}
.sets-sel{width:72px;background:var(--g100);border:1.5px solid transparent;border-radius:9px;
  padding:12px 8px;color:var(--navy);font-family:'DM Mono',monospace;font-size:14px;
  text-align:center;outline:none;cursor:pointer;transition:border-color .15s}
.sets-sel:focus{border-color:var(--accent)}
.btn-add{background:var(--navy);color:#fff;border:none;border-radius:9px;
  padding:12px 14px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;
  cursor:pointer;white-space:nowrap;transition:opacity .15s;flex-shrink:0}
.btn-add:active{opacity:.8}

/* ── BOTTOM ACTIONS (workout) ── */
.wk-actions{display:flex;flex-direction:column;gap:8px;margin-top:4px;padding-bottom:8px}
.btn-finish{width:100%;background:var(--green);color:#fff;border:none;
  border-radius:var(--rcard);padding:18px;font-family:'Syne',sans-serif;
  font-size:16px;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  box-shadow:0 6px 20px rgba(39,196,122,.3);transition:transform .12s}
.btn-finish:active{transform:scale(.97)}
.btn-finish svg{width:20px;height:20px;stroke:#fff;fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}
.btn-danger{width:100%;background:transparent;color:var(--g400);
  border:1.5px solid var(--g200);border-radius:var(--rcard);padding:14px;
  font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;transition:all .15s}
.btn-danger:active{background:var(--redbg);color:var(--red);border-color:var(--red)}

/* ── HISTORY ── */
.hist-card{background:var(--w);border-radius:var(--rcard);padding:16px;box-shadow:var(--sh);margin-bottom:10px}
.hist-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.hist-name{font-family:'Syne',sans-serif;font-size:15px;font-weight:700}
.hist-date{font-size:11px;color:var(--g400);transition:color 0.3s;font-family:'DM Mono',monospace}
.hist-items{display:flex;flex-direction:column;gap:6px}
.hist-item{display:flex;align-items:center;justify-content:space-between;
  padding:8px 11px;background:var(--g100);border-radius:8px}
.hist-iname{font-size:13px;font-weight:500;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:8px}
.hist-istat{font-family:'DM Mono',monospace;font-size:12px;color:var(--g400);flex-shrink:0}
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;color:var(--g400);padding:48px 28px;text-align:center}
.empty-icon{font-size:48px;line-height:1}
.empty-state p{font-size:14px;line-height:1.6}

/* ── EDITOR ── */
.editor-block{background:var(--w);border-radius:var(--rcard);padding:16px;box-shadow:var(--sh);margin-bottom:12px}
.editor-block h3{font-size:14px;margin-bottom:12px}
.inp-light{width:100%;background:var(--g100);border:1.5px solid transparent;border-radius:9px;
  padding:12px 14px;color:var(--navy);font-family:'DM Sans',sans-serif;
  font-size:15px;font-weight:500;outline:none;transition:border-color .15s,background .15s}
.inp-light:focus{border-color:var(--accent);background:var(--ag)}
.inp-light::placeholder{color:var(--g400)}
.emoji-row{display:flex;flex-wrap:wrap;gap:7px;margin-top:10px}
.emoji-opt{font-size:22px;width:42px;height:42px;border-radius:10px;
  border:2px solid var(--g200);background:var(--g100);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:border-color .15s,background .15s;user-select:none}
.emoji-opt.picked{border-color:var(--accent);background:var(--ag)}
.ex-builder{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;min-height:0}
.ex-build-row{display:flex;align-items:center;gap:8px;background:var(--g100);border-radius:9px;padding:9px 11px}
.ex-build-name{flex:1;font-size:13px;font-weight:500;color:var(--navy);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ex-build-sets{font-family:'DM Mono',monospace;font-size:12px;color:var(--g400);flex-shrink:0;margin-right:2px}
.btn-rm{background:none;border:none;padding:5px;cursor:pointer;color:var(--g400);flex-shrink:0;display:flex;align-items:center;border-radius:6px;transition:color .15s,background .15s}
.btn-rm:hover{color:var(--red);background:var(--redbg)}
.btn-rm svg{width:15px;height:15px;fill:currentColor;display:block}
.add-row{display:flex;gap:7px;align-items:stretch;margin-bottom:8px}
.divider{height:1px;background:var(--g100);margin:10px 0}
.cm-row{display:flex;gap:7px;margin-top:0}
.existing-prog-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
.existing-prog-item:not(:last-child){border-bottom:1px solid var(--g100)}
.ep-name{font-size:14px;font-weight:500;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:8px}
.ep-badge{font-size:11px;color:var(--g400);flex-shrink:0}
.btn-save{width:100%;background:var(--accent);color:#fff;border:none;
  border-radius:var(--rcard);padding:17px;font-family:'Syne',sans-serif;
  font-size:16px;font-weight:700;cursor:pointer;
  box-shadow:0 4px 18px rgba(74,144,217,.35);transition:transform .12s}
.btn-save:active{transform:scale(.97)}

/* ── TOAST ── */
.toast{position:fixed;bottom:calc(70px + var(--safe-b));left:50%;
  transform:translateX(-50%) translateY(16px);background:var(--navy);color:#fff;
  padding:12px 20px;border-radius:40px;font-size:14px;font-weight:600;
  opacity:0;transition:opacity .25s,transform .25s;z-index:800;
  white-space:nowrap;box-shadow:0 8px 32px rgba(27,39,53,.22);pointer-events:none;
  max-width:calc(100vw - 40px);text-overflow:ellipsis;overflow:hidden}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ── CONFETTI ── */
#confetti-cv{position:fixed;inset:0;pointer-events:none;z-index:900}

/* ── ANIMATIONS ── */
@keyframes pop{
  0%{transform:scale(.5) rotate(-8deg);opacity:0}
  60%{transform:scale(1.12) rotate(2deg);opacity:1}
  80%{transform:scale(.96) rotate(-1deg)}
  100%{transform:scale(1) rotate(0deg);opacity:1}
}
@keyframes slideUp{
  0%{opacity:0;transform:translateY(20px) scale(.97)}
  60%{opacity:1;transform:translateY(-3px) scale(1.005)}
  100%{opacity:1;transform:translateY(0) scale(1)}
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes quoteIn{
  0%{opacity:0;transform:translateY(8px) scale(.97)}
  70%{opacity:1;transform:translateY(-1px)}
  100%{opacity:1;transform:translateY(0)}
}
@keyframes quoteOut{
  0%{opacity:1;transform:translateY(0)}
  100%{opacity:0;transform:translateY(-10px) scale(.96)}
}
@keyframes checkPop{
  0%{transform:scale(1)}
  30%{transform:scale(1.35) rotate(-4deg)}
  55%{transform:scale(.88) rotate(2deg)}
  75%{transform:scale(1.08)}
  100%{transform:scale(1) rotate(0deg)}
}
@keyframes cardIn{
  0%{opacity:0;transform:translateY(22px) scale(.96)}
  55%{opacity:1;transform:translateY(-4px) scale(1.005)}
  80%{transform:translateY(1px) scale(.999)}
  100%{opacity:1;transform:translateY(0) scale(1)}
}
@keyframes ringPulse{
  0%,100%{opacity:1;filter:brightness(1)}
  50%{opacity:.7;filter:brightness(1.3)}
}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes screenSlideIn{
  0%{opacity:0;transform:translateX(22px) scale(.98)}
  65%{opacity:1;transform:translateX(-3px) scale(1.002)}
  100%{opacity:1;transform:translateX(0) scale(1)}
}
@keyframes statPop{
  0%{transform:scale(1)}
  40%{transform:scale(1.18)}
  70%{transform:scale(.94)}
  100%{transform:scale(1)}
}
@keyframes timerIn{
  0%{opacity:0;transform:translateX(-50%) translateY(12px) scale(.9)}
  60%{opacity:1;transform:translateX(-50%) translateY(-2px) scale(1.02)}
  100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}
}

.su{animation:slideUp .28s cubic-bezier(.34,1.38,.64,1) both}
.su:nth-child(1){animation-delay:.03s}
.su:nth-child(2){animation-delay:.07s}
.su:nth-child(3){animation-delay:.11s}
.su:nth-child(4){animation-delay:.15s}
.su:nth-child(5){animation-delay:.19s}
.su:nth-child(6){animation-delay:.23s}
.card-in{animation:cardIn .3s cubic-bezier(.34,1.3,.64,1) forwards}
.screen-in{animation:screenSlideIn .28s cubic-bezier(.34,1.2,.64,1) forwards}
.stat-pop{animation:statPop .3s cubic-bezier(.34,1.5,.64,1)}


/* ── QUOTE TRANSITIONS ── */
.greet-sub{font-size:13px;color:rgba(255,255,255,.5);margin-top:6px;min-height:20px;transition:opacity .3s}
.greet-sub.fade-out{animation:quoteOut .3s ease forwards}
.greet-sub.fade-in{animation:quoteIn .4s ease forwards}

/* ── NAME EDIT MODAL ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:700;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .25s;backdrop-filter:blur(3px)}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal-sheet{background:var(--w);border-radius:24px 24px 0 0;
  padding:24px 20px calc(28px + var(--safe-b));width:100%;max-width:430px;
  transform:translateY(100%);transition:transform .32s cubic-bezier(.22,.68,0,1.1)}
.modal-overlay.open .modal-sheet{transform:translateY(0)}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--navy);transition:color 0.3s}
[data-theme="dark"] .modal-title{color:#e8ecf2}

/* === COMPREHENSIVE DARK MODE TEXT OVERRIDES === */
[data-theme="dark"] .theme-panel h3 {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .theme-option {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .theme-close {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .tab.active {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .set-dd {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .set-dd option {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .wk-stat-val {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .prev-rec b {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .add-ex-title {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .add-ex-btn {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .ex-build-num {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .ex-build-name {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .btn-modal-sec {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .tb-edit:hover {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .settings-title {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .sett-row-label {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .timer-val {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .legal-link:active {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .info-title {
  color: #e8ecf2 !important;
}
[data-theme="dark"] .share-sheet-title {
  color: #e8ecf2 !important;
}


/* Additional readability improvements for dark mode */

/* Ensure all input placeholders are visible */
[data-theme="dark"] input::placeholder,
[data-theme="dark"] textarea::placeholder {
  color: rgba(255, 255, 255, 0.4) !important;
}

/* Ensure all labels are visible */
[data-theme="dark"] label,
[data-theme="dark"] .label {
  color: #b4b9c8 !important;
}

/* Meta text should be lighter but still readable */
[data-theme="dark"] .prog-meta,
[data-theme="dark"] .ex-det,
[data-theme="dark"] .ex-sub,
[data-theme="dark"] .hist-date,
[data-theme="dark"] .hist-ex,
[data-theme="dark"] .pr-val,
[data-theme="dark"] .pr-date,
[data-theme="dark"] .set-desc,
[data-theme="dark"] .aw-ex-det,
[data-theme="dark"] .aw-set-lbl,
[data-theme="dark"] .wk-stat-lbl,
[data-theme="dark"] .set-dd-unit,
[data-theme="dark"] .set-num,
[data-theme="dark"] .topbar-right,
[data-theme="dark"] .sett-row-desc,
[data-theme="dark"] .ob-sub {
  color: #8b92a8 !important;
}

/* Empty state text */
[data-theme="dark"] .empty-txt,
[data-theme="dark"] .empty-hint {
  color: #8b92a8 !important;
}

/* Section labels */
[data-theme="dark"] .slbl {
  color: #8b92a8 !important;
}

/* Modal input labels */
[data-theme="dark"] .minp-lbl {
  color: #b4b9c8 !important;
}

/* Ensure chevrons are visible */
[data-theme="dark"] .prog-chevron,
[data-theme="dark"] .set-chevron {
  fill: #8b92a8 !important;
}
/* Inline styled elements */
[data-theme="dark"] [style*="color:var(--navy)"] {
  color: #e8ecf2 !important;
}
/* Buttons erven de body-kleur in dark mode */
[data-theme="dark"] button { color: inherit; }
/* Timer pill selected */
[data-theme="dark"] .timer-pill.sel { background:var(--navy); color:#fff !important; }
.modal-close{background:var(--g100);border:none;width:32px;height:32px;border-radius:50%;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  color:var(--g600);font-size:16px;transition:background .15s}
.modal-close:hover{background:var(--g200)}
.modal-actions{display:flex;gap:10px;margin-top:14px}
.btn-modal-sec{flex:1;background:var(--g100);color:var(--navy);border:none;
  border-radius:10px;padding:15px;font-family:'DM Sans',sans-serif;
  font-size:15px;font-weight:600;cursor:pointer;transition:background .15s}
.btn-modal-sec:hover{background:var(--g200)}
.btn-modal-pri{flex:1;background:var(--accent);color:#fff;border:none;
  border-radius:10px;padding:15px;font-family:'Syne',sans-serif;
  font-size:15px;font-weight:700;cursor:pointer;
  box-shadow:0 4px 14px rgba(74,144,217,.35);transition:transform .12s}
.btn-modal-pri:active{transform:scale(.97)}

/* ── EDIT NAME BUTTON in topbar ── */
.tb-edit{background:none;border:none;padding:6px;cursor:pointer;border-radius:7px;
  color:var(--g400);display:flex;align-items:center;transition:color .15s,background .15s;margin-left:2px}
.tb-edit:hover{background:var(--g100);color:var(--navy)}
.tb-edit svg{width:14px;height:14px;fill:currentColor}

/* ── RIPPLE ON BUTTONS ── */
.btn-start,.btn-finish,.btn-primary{position:relative;overflow:hidden}
.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,.3);
  transform:scale(0);animation:rippleAnim .5s linear;pointer-events:none}
@keyframes rippleAnim{to{transform:scale(4);opacity:0}}

/* ── SET CHECK ANIMATION ── */
.set-ck.popping{animation:checkPop .3s ease}

/* ── GREETING CARD shimmer accent ── */
.greet-card{position:relative;overflow:hidden}
.greet-card::after{content:'';position:absolute;top:-50%;right:-60px;width:160px;height:200%;
  background:rgba(255,255,255,.04);border-radius:50%;pointer-events:none}

/* ── PROGRESS RING DONE PULSE ── */
.ring.complete .ring-f{animation:ringPulse 1.5s ease infinite}

/* ── ADD SET BUTTON ── */
.btn-add-set{
  width:100%;background:transparent;border:1.5px dashed var(--g200);
  border-radius:10px;padding:9px;color:var(--g400);
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;
  transition:border-color .15s,color .15s,background .15s;margin:0 0 12px
}
.btn-add-set:hover{border-color:var(--accent);color:var(--accent);background:var(--ag)}
.btn-add-set:active{transform:scale(.97)}
.btn-add-set svg{width:14px;height:14px;fill:currentColor}
.btn-rm-set{width:26px;height:40px;border:none;background:transparent;
  color:var(--g200);cursor:pointer;display:flex;align-items:center;justify-content:center;
  border-radius:8px;flex-shrink:0;transition:color .15s,background .15s;padding:0}
.btn-rm-set:active{color:var(--red)}
.btn-rm-set svg{width:13px;height:13px;fill:currentColor}

/* ── SETTINGS MODAL ── */
.settings-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:750;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .25s;backdrop-filter:blur(4px)
}
.settings-overlay.open{opacity:1;pointer-events:all}
.settings-sheet{
  background:var(--off);border-radius:28px 28px 0 0;
  width:100%;max-width:430px;
  padding:0 0 calc(env(safe-area-inset-bottom,0px) + 16px);
  transform:translateY(100%);transition:transform .34s cubic-bezier(.22,.68,0,1.1);
  max-height:90dvh;display:flex;flex-direction:column
}
.settings-overlay.open .settings-sheet{transform:translateY(0)}
.settings-handle{width:36px;height:4px;background:var(--g200);border-radius:2px;margin:12px auto 0}
.settings-hd{padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.settings-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--navy)}
.settings-body{overflow-y:auto;flex:1;padding:0 16px 16px}
.sett-section{margin-bottom:20px}
.sett-section-lbl{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  color:var(--g400);margin-bottom:8px;padding:0 4px;display:block}
.sett-card{background:var(--w);border-radius:var(--rcard);box-shadow:var(--sh);overflow:hidden}
.sett-row{display:flex;align-items:center;gap:12px;padding:14px 16px;
  border-bottom:1px solid var(--g100)}
.sett-row:last-child{border-bottom:none}
.sett-row-icon{width:36px;height:36px;border-radius:10px;background:var(--g100);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px}
.sett-row-icon svg{width:18px;height:18px;fill:var(--accent)}
.sett-row-info{flex:1;min-width:0}
.sett-row-label{font-size:14px;font-weight:600;color:var(--navy)}
.sett-row-sub{font-size:12px;color:var(--g400);margin-top:2px}
/* Toggle switch */
.toggle-wrap{position:relative;width:46px;height:26px;flex-shrink:0}
.toggle-inp{position:absolute;opacity:0;width:0;height:0}
.toggle-track{display:block;width:46px;height:26px;border-radius:13px;
  background:var(--g200);cursor:pointer;transition:background .2s;position:relative}
.toggle-inp:checked + .toggle-track{background:var(--accent)}
.toggle-track::after{content:'';position:absolute;top:3px;left:3px;
  width:20px;height:20px;border-radius:50%;background:#fff;
  box-shadow:0 1px 4px rgba(0,0,0,.2);transition:transform .2s}
.toggle-inp:checked + .toggle-track::after{transform:translateX(20px)}
/* Timer pills */
.timer-pills{display:flex;gap:6px;flex-wrap:wrap;padding:12px 16px 14px}
.timer-pill{flex:1;min-width:calc(33% - 4px);border:1.5px solid var(--g200);
  background:transparent;border-radius:10px;padding:10px 6px;cursor:pointer;
  font-family:'DM Mono',monospace;font-size:13px;font-weight:500;color:var(--g600);
  text-align:center;transition:all .15s}
.timer-pill.sel{background:var(--navy);border-color:var(--navy);color:#fff;font-weight:700}
/* Custom timer input */
.timer-custom-row{display:flex;gap:8px;align-items:center;padding:0 16px 14px}
.timer-custom-inp{width:70px;background:var(--g100);border:1.5px solid transparent;border-radius:9px;
  padding:10px 8px;color:var(--navy);font-family:'DM Mono',monospace;font-size:15px;font-weight:500;
  text-align:center;outline:none;transition:border-color .15s;-webkit-appearance:none;appearance:none}
.timer-custom-inp:focus{border-color:var(--accent);background:var(--ag)}
.timer-custom-lbl{font-size:13px;font-weight:600;color:var(--g600);flex-shrink:0}
/* Profile avatar */
.profile-avatar{width:64px;height:64px;border-radius:18px;background:var(--navy);
  display:flex;align-items:center;justify-content:center;font-size:32px;
  box-shadow:0 4px 14px rgba(27,39,53,.18);flex-shrink:0;cursor:pointer}
.avatar-emoji-grid{display:flex;flex-wrap:wrap;gap:8px;padding:12px 16px 14px}
.avatar-opt{width:44px;height:44px;border-radius:12px;border:2px solid var(--g200);
  background:var(--g100);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:22px;transition:border-color .15s,background .15s}
.avatar-opt.picked{border-color:var(--accent);background:var(--ag)}
/* Gear button */
.tb-gear{background:none;border:none;padding:7px;cursor:pointer;border-radius:8px;
  color:var(--g400);display:flex;align-items:center;transition:color .15s,background .15s}
.tb-gear:active{background:var(--g100);color:var(--navy)}
.tb-gear svg{width:18px;height:18px;fill:currentColor}

/* ── WAKE LOCK INDICATOR ── */
.wakelock-badge{
  display:none;align-items:center;gap:4px;
  background:rgba(39,196,122,.15);color:var(--green);
  border:1px solid rgba(39,196,122,.3);border-radius:20px;
  padding:4px 8px;font-size:10px;font-weight:700;letter-spacing:.02em;
  white-space:nowrap;flex-shrink:0
}
.wakelock-badge.active{display:flex}
.wakelock-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.5s ease infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.3)}}

/* ── LEGAL PAGES & INFO ── */
.legal-link{
  text-decoration:none;color:var(--accent);font-weight:600;
  transition:color .15s;display:inline-flex;align-items:center;gap:4px
}
.legal-link:active{color:var(--navy)}
.legal-link svg{width:12px;height:12px;fill:currentColor}
.info-section{margin-bottom:16px}
.info-title{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:8px;
  display:flex;align-items:center;gap:6px}
.info-text{font-size:13px;color:var(--g600);line-height:1.6;margin-bottom:8px}
.info-list{padding-left:20px;margin:8px 0}
.info-list li{font-size:13px;color:var(--g600);line-height:1.7;margin-bottom:6px}
.version-badge{display:inline-block;background:var(--g100);color:var(--g600);
  font-size:11px;font-weight:700;padding:4px 8px;border-radius:6px;font-family:'DM Mono',monospace}

/* ── SHARE MODAL ── */
.share-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:850;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .3s;backdrop-filter:blur(8px)
}
.share-overlay.open{opacity:1;pointer-events:all}
.share-sheet{
  background:var(--off);border-radius:28px 28px 0 0;
  width:100%;max-width:430px;padding:0 0 calc(16px + var(--safe-b));
  transform:translateY(100%);transition:transform .35s cubic-bezier(.22,.68,0,1.1);
  max-height:92dvh;overflow-y:auto;overflow-x:hidden;
}
.share-overlay.open .share-sheet{transform:translateY(0)}
.share-sheet-hd{
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 20px 14px;position:sticky;top:0;background:var(--off);
  border-bottom:1px solid var(--g100);z-index:2;
}
.share-sheet-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--navy)}
.share-canvas-wrap{
  width:calc(100% - 32px);margin:16px auto;background:var(--navy);border-radius:20px;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 16px 48px rgba(27,39,53,.4);position:relative;
}
.share-canvas-wrap canvas{width:100%;height:auto;display:block}
/* Background picker */
.share-bg-section{padding:0 20px 14px}
.share-bg-label{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--g400);margin-bottom:10px;display:block}
.share-bg-pills{display:flex;gap:8px}
.bg-pill{flex:1;border:1.5px solid var(--g200);border-radius:12px;padding:10px 6px;
  background:var(--w);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:5px;
  font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;color:var(--g600);
  transition:all .18s;box-shadow:0 1px 4px rgba(27,39,53,.06)}
.bg-pill:active{transform:scale(.96)}
.bg-pill.active{border-color:var(--accent);background:var(--ag);color:var(--accent)}
.bg-pill svg{width:20px;height:20px;fill:currentColor}
.bg-pill-icon{font-size:18px;line-height:1}
.share-bg-preview{width:100%;height:52px;border-radius:10px;object-fit:cover;display:none;margin-top:10px;border:2px solid var(--accent)}
/* Share buttons */
.share-btns-section{padding:0 20px;display:flex;flex-direction:column;gap:10px}
.share-btns-row{display:flex;gap:10px}
.btn-share-action{
  flex:1;border:none;border-radius:var(--rcard);padding:16px 10px;
  font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;
  transition:transform .12s,opacity .12s;position:relative;overflow:hidden;
}
.btn-share-action:active{transform:scale(.97);opacity:.9}
.btn-share-action svg{width:18px;height:18px;fill:currentColor;flex-shrink:0}
.btn-share-dl{background:var(--navy);color:#fff;box-shadow:0 4px 14px rgba(27,39,53,.2)}
.btn-share-native{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(74,144,217,.35)}
.btn-share-native.hidden{display:none}
/* Instagram button */
.btn-share-ig{
  width:100%;border:none;border-radius:var(--rcard);padding:16px;
  font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px;
  color:#fff;transition:transform .12s,opacity .12s;
  background:linear-gradient(135deg,#f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
  box-shadow:0 6px 20px rgba(220,39,67,.4);
}
.btn-share-ig:active{transform:scale(.97);opacity:.9}
.btn-share-ig svg{width:20px;height:20px;fill:#fff;flex-shrink:0}
.ig-tip{font-size:11px;color:var(--g400);text-align:center;padding:4px 20px 0;line-height:1.5}
/* Loading overlay for canvas */
.canvas-loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(27,39,53,.6);border-radius:20px;opacity:0;pointer-events:none;transition:opacity .2s}
.canvas-loading.show{opacity:1;pointer-events:all}
.canvas-spinner{width:32px;height:32px;border:3px solid rgba(255,255,255,.2);
  border-top-color:#4A90D9;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ══════════════════════════════════════════════════════════════════════════════
   INSTAGRAM-STYLE SHARE EDITOR
══════════════════════════════════════════════════════════════════════════════ */
.share-editor-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 900;
  display: none;
  opacity: 0;
  transition: opacity 0.3s;
}
.share-editor-overlay.open {
  display: flex;
  opacity: 1;
}

.share-editor-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  max-width: 430px;
  margin: 0 auto;
}

/* Top Bar */
.share-editor-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: calc(12px + var(--safe-t)) 16px 12px;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
}
.share-editor-topbar button {
  background: transparent;
  border: none;
  color: #fff;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 600;
  padding: 8px 12px;
  cursor: pointer;
}
.share-editor-topbar button:active {
  opacity: 0.7;
}
.share-editor-title {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: #fff;
}

/* Canvas Area */
.share-editor-canvas-area {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.share-canvas-container {
  position: relative;
  width: 100%;
  max-width: 360px;
  aspect-ratio: 9/16;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

/* Background Image */
.share-canvas-bg {
  position: absolute;
  inset: 0;
  object-fit: cover;
  opacity: 1;
  transition: opacity 0.3s;
}

/* Draggable Elements */
.draggable-element {
  position: absolute;
  cursor: move;
  touch-action: none;
  user-select: none;
  padding: 12px 16px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  min-width: 120px;
  transition: transform 0.1s, box-shadow 0.2s;
}

.draggable-element.dragging {
  transform: scale(1.05);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  z-index: 100;
}

.draggable-element.selected {
  box-shadow: 0 0 0 3px var(--accent), 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Background variants */
.draggable-element.bg-none {
  background: transparent;
  box-shadow: none;
}

.draggable-element.bg-semi {
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
}

.draggable-element.bg-dark {
  background: rgba(27, 39, 53, 0.9);
  color: #fff;
}

.draggable-element.bg-dark-semi {
  background: rgba(27, 39, 53, 0.6);
  backdrop-filter: blur(10px);
  color: #fff;
}

.draggable-element.bg-dark .element-label,
.draggable-element.bg-dark-semi .element-label {
  opacity: 0.7;
}

/* Font Styles */
.font-syne {
  font-family: 'Syne', sans-serif !important;
}

.font-dm-sans {
  font-family: 'DM Sans', sans-serif !important;
}

.font-dm-mono {
  font-family: 'DM Mono', monospace !important;
}

.font-impact {
  font-family: Impact, 'Arial Black', sans-serif !important;
  letter-spacing: 0.02em;
}

.font-cursive {
  font-family: 'Brush Script MT', 'Comic Sans MS', cursive !important;
}

/* Element content */
.element-label {
  font-size: 11px;
  font-weight: 700;
  opacity: 0.6;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 4px;
}

.element-value {
  font-size: 24px;
  font-weight: 800;
  line-height: 1.1;
  display: flex;
  align-items: center;
}

.element-emoji {
  font-size: 20px;
  margin-right: 6px;
}

/* Bottom Toolbar */
.share-editor-toolbar {
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(20px);
  padding: 12px 16px calc(12px + var(--safe-b));
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 45vh;
  overflow-y: auto;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toolbar-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: rgba(255, 255, 255, 0.6);
}

.toolbar-options {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}

.toolbar-options::-webkit-scrollbar {
  display: none;
}

.toolbar-btn {
  flex-shrink: 0;
  background: rgba(255, 255, 255, 0.1);
  border: 1.5px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  padding: 8px 14px;
  color: #fff;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.toolbar-btn:active {
  transform: scale(0.95);
}

.toolbar-btn.active {
  background: var(--accent);
  border-color: var(--accent);
}

.toolbar-btn.disabled {
  opacity: 0.3;
  pointer-events: none;
}

/* Font preview in buttons */
.font-preview-syne {
  font-family: 'Syne', sans-serif;
}

.font-preview-mono {
  font-family: 'DM Mono', monospace;
}

.font-preview-impact {
  font-family: Impact, sans-serif;
}

.font-preview-cursive {
  font-family: cursive;
}

/* Action Buttons */
.editor-actions {
  display: flex;
  gap: 8px;
}

.editor-action-btn {
  flex: 1;
  background: var(--accent);
  border: none;
  border-radius: 12px;
  padding: 14px;
  color: #fff;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}

.editor-action-btn:active {
  transform: scale(0.97);
}

.editor-action-btn svg {
  width: 18px;
  height: 18px;
  fill: currentColor;
}

.editor-action-btn.secondary {
  background: rgba(255, 255, 255, 0.15);
}

/* Toggle buttons for elements */
.elements-toggle {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.element-toggle-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1.5px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  padding: 6px 12px;
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 4px;
}

.element-toggle-btn.active {
  background: rgba(39, 196, 122, 0.3);
  border-color: var(--green);
  color: var(--green);
}

.element-toggle-btn:active {
  transform: scale(0.95);
}

/* Loading state */
.editor-loading {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.8);
  border-radius: 20px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.editor-loading.show {
  opacity: 1;
  pointer-events: all;
}

.editor-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(255, 255, 255, 0.2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
</style>
</head>
<body>
<div id="app">

<!-- THEME MODAL -->
<div class="theme-modal" id="theme-modal">
  <div class="theme-panel">
    <h3>Thema selecteren</h3>
    <div class="theme-options">
      <button class="theme-option" data-theme="auto" onclick="selectTheme('auto')">
        <svg viewBox="0 0 24 24"><path d="M12 2a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm0 15a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm9-4a1 1 0 0 1-1 1h-1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1zM6 13a1 1 0 1 1 0-2H5a1 1 0 1 1 0 2h1zm-.2-7.8a1 1 0 0 1 0 1.4l-.7.7a1 1 0 0 1-1.4-1.4l.7-.7a1 1 0 0 1 1.4 0zm14.1 1.4a1 1 0 0 1-1.4 0l-.7-.7a1 1 0 0 1 1.4-1.4l.7.7a1 1 0 0 1 0 1.4zM12 18a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1zm7.1-1.9a1 1 0 0 1 0 1.4l-.7.7a1 1 0 1 1-1.4-1.4l.7-.7a1 1 0 0 1 1.4 0zM6.6 17.4a1 1 0 0 1-1.4 0l-.7-.7a1 1 0 0 1 1.4-1.4l.7.7a1 1 0 0 1 0 1.4z"/></svg>
        <div class="theme-option-text">
          <span class="theme-option-label">Automatisch</span>
          <span class="theme-option-desc">Volgt systeeminstelling</span>
        </div>
      </button>
      <button class="theme-option" data-theme="light" onclick="selectTheme('light')">
        <svg viewBox="0 0 24 24"><path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1zm8 8a1 1 0 0 1-1 1h-1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1zM6 12a1 1 0 1 1 0-2H5a1 1 0 1 1 0 2h1zm-.2-6.8a1 1 0 0 1 0 1.4l-.7.7a1 1 0 0 1-1.4-1.4l.7-.7a1 1 0 0 1 1.4 0zm14.1 1.4a1 1 0 0 1-1.4 0l-.7-.7a1 1 0 0 1 1.4-1.4l.7.7a1 1 0 0 1 0 1.4zM12 18a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1zm7.1-1.9a1 1 0 0 1 0 1.4l-.7.7a1 1 0 1 1-1.4-1.4l.7-.7a1 1 0 0 1 1.4 0zM6.6 17.4a1 1 0 0 1-1.4 0l-.7-.7a1 1 0 0 1 1.4-1.4l.7.7a1 1 0 0 1 0 1.4z"/></svg>
        <div class="theme-option-text">
          <span class="theme-option-label">Licht</span>
          <span class="theme-option-desc">Altijd lichte modus</span>
        </div>
      </button>
      <button class="theme-option" data-theme="dark" onclick="selectTheme('dark')">
        <svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
        <div class="theme-option-text">
          <span class="theme-option-label">Donker</span>
          <span class="theme-option-desc">Altijd donkere modus</span>
        </div>
      </button>
    </div>
    <button class="theme-close" onclick="closeThemeModal()">Sluiten</button>
  </div>
</div>

<!-- SHARE EDITOR -->
<div class="share-editor-overlay" id="share-editor">
  <div class="share-editor-container">
    <!-- Top Bar -->
    <div class="share-editor-topbar">
      <button onclick="closeShareEditor()">Annuleren</button>
      <div class="share-editor-title">Story Editor</div>
      <button onclick="saveShareImage()">Opslaan</button>
    </div>

    <!-- Canvas Area -->
    <div class="share-editor-canvas-area">
      <div class="share-canvas-container" id="share-canvas">
        <!-- Background Image -->
        <img class="share-canvas-bg" id="share-bg-img" src="" alt="" style="display:none">
        
        <!-- Draggable Stats Elements -->
        <div class="draggable-element" id="elem-workout" data-stat="workout" style="top: 60px; left: 20px;">
          <div class="element-content">
            <div class="element-label">Workout</div>
            <div class="element-value">
              <span class="element-emoji" style="display:none">💪</span>
              <span class="element-text">Push Day</span>
            </div>
          </div>
        </div>

        <div class="draggable-element" id="elem-duration" data-stat="duration" style="top: 180px; left: 20px;">
          <div class="element-content">
            <div class="element-label">Duur</div>
            <div class="element-value">
              <span class="element-emoji" style="display:none">⏱️</span>
              <span class="element-text">52 min</span>
            </div>
          </div>
        </div>

        <div class="draggable-element" id="elem-exercises" data-stat="exercises" style="top: 300px; left: 20px;">
          <div class="element-content">
            <div class="element-label">Oefeningen</div>
            <div class="element-value">
              <span class="element-emoji" style="display:none">🏋️</span>
              <span class="element-text">8</span>
            </div>
          </div>
        </div>

        <div class="draggable-element" id="elem-pr" data-stat="pr" style="top: 420px; left: 20px;">
          <div class="element-content">
            <div class="element-label">Nieuw PR!</div>
            <div class="element-value">
              <span class="element-emoji" style="display:none">🔥</span>
              <span class="element-text">120kg</span>
            </div>
          </div>
        </div>

        <!-- Loading overlay -->
        <div class="editor-loading" id="editor-loading">
          <div class="editor-spinner"></div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="share-editor-toolbar">
      <!-- Element Visibility Toggles -->
      <div class="toolbar-section">
        <div class="toolbar-label">Elementen</div>
        <div class="elements-toggle">
          <button class="element-toggle-btn active" data-element="workout" onclick="toggleElement('workout')">Workout</button>
          <button class="element-toggle-btn active" data-element="duration" onclick="toggleElement('duration')">Duur</button>
          <button class="element-toggle-btn active" data-element="exercises" onclick="toggleElement('exercises')">Oefeningen</button>
          <button class="element-toggle-btn active" data-element="pr" onclick="toggleElement('pr')">PR</button>
        </div>
      </div>

      <!-- Font Selection -->
      <div class="toolbar-section" id="font-section" style="display:none">
        <div class="toolbar-label">Lettertype</div>
        <div class="toolbar-options">
          <button class="toolbar-btn active font-preview-syne" onclick="setElementFont('syne')">Syne</button>
          <button class="toolbar-btn" onclick="setElementFont('dm-sans')">DM Sans</button>
          <button class="toolbar-btn font-preview-mono" onclick="setElementFont('dm-mono')">Mono</button>
          <button class="toolbar-btn font-preview-impact" onclick="setElementFont('impact')">Impact</button>
          <button class="toolbar-btn font-preview-cursive" onclick="setElementFont('cursive')">Cursive</button>
        </div>
      </div>

      <!-- Background Style -->
      <div class="toolbar-section" id="bg-section" style="display:none">
        <div class="toolbar-label">Achtergrond Element</div>
        <div class="toolbar-options">
          <button class="toolbar-btn active" onclick="setElementBg('solid')">Vol</button>
          <button class="toolbar-btn" onclick="setElementBg('semi')">Semi</button>
          <button class="toolbar-btn" onclick="setElementBg('none')">Geen</button>
          <button class="toolbar-btn" onclick="setElementBg('dark')">Donker</button>
          <button class="toolbar-btn" onclick="setElementBg('dark-semi')">Donker Semi</button>
        </div>
      </div>

      <!-- Emoji Toggle -->
      <div class="toolbar-section" id="emoji-section" style="display:none">
        <div class="toolbar-label">Emoji</div>
        <div class="toolbar-options">
          <button class="toolbar-btn" onclick="toggleEmoji()">
            <span id="emoji-btn-text">Emoji toevoegen</span>
          </button>
        </div>
      </div>

      <!-- Background Image -->
      <div class="toolbar-section">
        <div class="toolbar-label">Achtergrond</div>
        <div class="toolbar-options">
          <button class="toolbar-btn active" onclick="setBgType('gradient')">Gradient</button>
          <button class="toolbar-btn" onclick="openBgImagePicker()">
            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;margin-right:4px"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            Afbeelding
          </button>
          <input type="file" id="bg-image-input" accept="image/*" style="display:none" onchange="handleBgImage(event)">
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="editor-actions">
        <button class="editor-action-btn secondary" onclick="resetLayout()">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Reset
        </button>
        <button class="editor-action-btn" onclick="downloadShareImage()">
          <svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg>
          Download
        </button>
      </div>
    </div>
  </div>
</div>

<!-- LOADING -->
<div id="scr-loading" class="screen active">
  <div class="loading-logo"><svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29l-1.43-1.43z"/></svg></div>
  <div class="loading-txt">Basis Fit laden…</div>
</div>

<!-- AUTH / ONBOARDING -->
<div id="scr-onboard" class="screen">
  <div class="auth-wrap">
    <div class="ob-icon"><svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29l-1.43-1.43z"/></svg></div>
    <div class="ob-title">Basis Fit</div>
    <div class="ob-sub">Jouw persoonlijke workout tracker</div>

    <!-- Google button -->
    <button class="btn-google" onclick="signInGoogle()">
      <!-- Google G logo SVG -->
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
      Doorgaan met Google
    </button>

    <div class="auth-divider"><span>of met e-mail</span></div>

    <!-- Auth tabs: login / register -->
    <div class="auth-tabs" style="margin-top:4px">
      <button class="auth-tab active" id="tab-login" onclick="authSwitchTab('login')">Inloggen</button>
      <button class="auth-tab" id="tab-register" onclick="authSwitchTab('register')">Registreren</button>
    </div>

    <!-- Login form -->
    <div class="auth-form-panel active" id="panel-login">
      <input id="inp-email-login" class="inp-dark" type="email" placeholder="E-mailadres" autocomplete="email" inputmode="email"/>
      <input id="inp-pw-login" class="inp-dark" type="password" placeholder="Wachtwoord" autocomplete="current-password"/>
      <div class="auth-err" id="err-login"></div>
      <button class="btn-primary" id="btn-login" onclick="signInEmail()">Inloggen →</button>
    </div>

    <!-- Register form -->
    <div class="auth-form-panel" id="panel-register">
      <input id="inp-name-reg" class="inp-dark" type="text" placeholder="Jouw naam" autocomplete="given-name"/>
      <input id="inp-email-reg" class="inp-dark" type="email" placeholder="E-mailadres" autocomplete="email" inputmode="email"/>
      <input id="inp-pw-reg" class="inp-dark" type="password" placeholder="Wachtwoord (min. 6 tekens)" autocomplete="new-password"/>
      <div class="auth-err" id="err-register"></div>
      <button class="btn-primary" id="btn-register" onclick="registerEmail()">Account aanmaken →</button>
    </div>
  </div>
</div>

<!-- NAME EDIT MODAL -->
<div class="modal-overlay" id="name-modal">
  <div class="modal-sheet">
    <div class="modal-hd">
      <div class="modal-title">Naam wijzigen</div>
      <button class="modal-close" onclick="closeNameModal()">✕</button>
    </div>
    <span class="flbl" style="color:var(--g600)">Jouw naam</span>
    <input id="inp-name-edit" class="inp-light" type="text" placeholder="Jouw naam…" maxlength="30" style="margin-top:6px"/>
    <div class="modal-actions">
      <button class="btn-modal-sec" onclick="closeNameModal()">Annuleer</button>
      <button class="btn-modal-pri" onclick="saveName()">Opslaan</button>
    </div>
  </div>
</div>

<!-- HOME -->
<div id="scr-home" class="screen">
  <div class="topbar">
    <div class="tb-left">
      <div class="tb-logo"><svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29l-1.43-1.43z"/></svg></div>
      <h2>Basis Fit</h2>
    </div>
    <div class="tb-right">
      <div class="topbar-right" id="home-greet"></div>      <button class="theme-toggle" onclick="openThemeModal()" aria-label="Thema wijzigen">
        <svg viewBox="0 0 24 24" id="theme-icon">
          <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
        </svg>
      </button>

      <button class="tb-gear" onclick="openSettings()" title="Instellingen" aria-label="Instellingen">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
      </button>
    </div>
  </div>
  <div class="scroll-body"><div class="pad" id="home-body"></div></div>
  <div class="tabbar">
    <button class="tab active" data-tab="home" onclick="goTab('home')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</button>
    <button class="tab" data-tab="history" onclick="goTab('history')"><svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>Sessies</button>
    <button class="tab" data-tab="editor" onclick="goTab('editor')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Schema's</button>
  </div>
</div>

<!-- WORKOUT -->
<div id="scr-workout" class="screen">
  <div class="topbar">
    <div class="tb-left">
      <div class="tb-logo"><svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29l-1.43-1.43z"/></svg></div>
      <h2 id="wk-title">Training</h2>
    </div>
    <div class="tb-right">
      <div class="wakelock-badge" id="wakelock-badge"><span class="wakelock-dot"></span>Actief</div>
    </div>
  </div>
  <div class="scroll-body"><div class="pad" id="wk-body"></div></div>
</div>

<!-- HISTORY -->
<div id="scr-history" class="screen">
  <div class="topbar"><div class="tb-left"><div class="tb-logo"><svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg></div><h2>Sessies</h2></div><div class="tb-right"><button class="theme-toggle" onclick="openThemeModal()" aria-label="Thema wijzigen"><svg viewBox="0 0 24 24" id="theme-icon"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg></button></div></div>
  <div class="scroll-body"><div class="pad" id="hist-body"></div></div>
  <div class="tabbar">
    <button class="tab" data-tab="home" onclick="goTab('home')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</button>
    <button class="tab active" data-tab="history" onclick="goTab('history')"><svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>Sessies</button>
    <button class="tab" data-tab="editor" onclick="goTab('editor')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Schema's</button>
  </div>
</div>

<!-- EDITOR -->
<div id="scr-editor" class="screen">
  <div class="topbar"><div class="tb-left"><div class="tb-logo"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></div><h2>Schema's</h2></div><div class="tb-right"><button class="theme-toggle" onclick="openThemeModal()" aria-label="Thema wijzigen"><svg viewBox="0 0 24 24" id="theme-icon"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg></button></div></div>
  <div class="scroll-body"><div class="pad" id="editor-body"></div></div>
  <div class="tabbar">
    <button class="tab" data-tab="home" onclick="goTab('home')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</button>
    <button class="tab" data-tab="history" onclick="goTab('history')"><svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>Sessies</button>
    <button class="tab active" data-tab="editor" onclick="goTab('editor')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Schema's</button>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="settings-overlay" id="settings-overlay" onclick="settingsOverlayClick(event)">
  <div class="settings-sheet" id="settings-sheet">
    <div class="settings-handle"></div>
    <div class="settings-hd">
      <div class="settings-title">⚙️ Instellingen</div>
      <button class="modal-close" onclick="closeSettings()">✕</button>
    </div>
    <div class="settings-body" id="settings-body">
      <!-- Rendered by JS -->
    </div>
  </div>
</div>

<!-- ABOUT MODAL -->
<div class="settings-overlay" id="about-overlay" onclick="aboutOverlayClick(event)">
  <div class="settings-sheet">
    <div class="settings-handle"></div>
    <div class="settings-hd">
      <button class="modal-close" onclick="closeAbout()" style="order:-1;margin-right:12px">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      </button>
      <div class="settings-title">ℹ️ Over deze app</div>
      <div style="width:32px"></div>
    </div>
    <div class="settings-body">
      <div class="sett-card" style="margin-bottom:16px">
        <div style="padding:20px;text-align:center">
          <div style="width:80px;height:80px;background:var(--navy);border-radius:20px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 8px 24px rgba(27,39,53,.25)">
            <svg width="42" height="42" viewBox="0 0 24 24" fill="#fff"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29l-1.43-1.43z"/></svg>
          </div>
          <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--navy);margin-bottom:4px">Basis-Fit</div>
          <div class="version-badge" style="margin-bottom:16px">Versie 1.0.0</div>
          <div style="font-size:13px;color:var(--g600);line-height:1.6">
            Jouw persoonlijke workout tracker voor het bijhouden van trainingen, schema's en persoonlijke records. Ontwikkeld met 💪 voor fitness enthousiastelingen in Nederland.
          </div>
        </div>
      </div>

      <div class="sett-section">
        <span class="sett-section-lbl">Features</span>
        <div class="sett-card">
          <div style="padding:16px">
            <div class="info-section">
              <div class="info-title">🏋️ Workout Tracking</div>
              <div class="info-text">Houd al je trainingen bij met vooraf ingestelde schema's of maak je eigen programma's. Real-time voortgang, volume tracking en automatische PR detectie.</div>
            </div>
            <div class="info-section">
              <div class="info-title">☁️ Cloud Sync</div>
              <div class="info-text">Al je data wordt automatisch gesynchroniseerd via Firebase. Log in op elk apparaat en ga verder waar je was gebleven.</div>
            </div>
            <div class="info-section">
              <div class="info-title">📤 Delen</div>
              <div class="info-text">Deel je workouts met vrienden via Instagram Stories of andere apps. Kies je eigen achtergrond en toon je prestaties!</div>
            </div>
            <div class="info-section" style="margin-bottom:0">
              <div class="info-title">📱 Progressive Web App</div>
              <div class="info-text">Installeer de app op je home screen voor een volledig app-ervaring. Werkt offline en houdt je scherm actief tijdens trainingen.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="sett-section">
        <span class="sett-section-lbl">Technologie</span>
        <div class="sett-card">
          <div style="padding:16px">
            <div class="info-text" style="margin-bottom:8px"><strong>Frontend:</strong> Vanilla JavaScript, HTML5, CSS3</div>
            <div class="info-text" style="margin-bottom:8px"><strong>Backend:</strong> Firebase (Authentication, Firestore, Analytics)</div>
            <div class="info-text" style="margin-bottom:0"><strong>Hosting:</strong> Vercel</div>
          </div>
        </div>
      </div>

      <div class="sett-section">
        <span class="sett-section-lbl">Links</span>
        <div class="sett-card">
          <div style="padding:16px;display:flex;flex-direction:column;gap:12px">
            <a href="https://basis-fit.vercel.app" target="_blank" class="legal-link" style="font-size:14px">
              🌐 Website bezoeken
              <svg viewBox="0 0 24 24" width="14" height="14"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
            </a>
            <a onclick="closeAbout();setTimeout(showPrivacy,350)" class="legal-link" style="font-size:14px;cursor:pointer">
              🔒 Privacybeleid lezen
            </a>
            <a onclick="closeAbout();setTimeout(showTerms,350)" class="legal-link" style="font-size:14px;cursor:pointer">
              📄 Gebruiksvoorwaarden lezen
            </a>
          </div>
        </div>
      </div>

      <div style="padding:20px;text-align:center">
        <div style="font-size:12px;color:var(--g400);line-height:1.6">
          © 2025 Basis-Fit Workout Tracker<br>
          Gemaakt met 💪 in Nederland
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PRIVACY POLICY MODAL -->
<div class="settings-overlay" id="privacy-overlay" onclick="privacyOverlayClick(event)">
  <div class="settings-sheet">
    <div class="settings-handle"></div>
    <div class="settings-hd">
      <button class="modal-close" onclick="closePrivacy()" style="order:-1;margin-right:12px">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      </button>
      <div class="settings-title">🔒 Privacybeleid</div>
      <div style="width:32px"></div>
    </div>
    <div class="settings-body">
      <div class="sett-card" style="margin-bottom:16px">
        <div style="padding:20px">
          <div class="info-text" style="font-size:12px;color:var(--g400);margin-bottom:16px">
            <strong>Laatst bijgewerkt:</strong> 24 februari 2025
          </div>

          <div class="info-section">
            <div class="info-title">📋 Wat we verzamelen</div>
            <div class="info-text">De Basis-Fit Workout Tracker verzamelt de volgende gegevens om de app voor jou te laten werken:</div>
            <ul class="info-list">
              <li><strong>Accountgegevens:</strong> Je naam, e-mailadres (alleen bij registratie)</li>
              <li><strong>Trainingsdata:</strong> Workout sessies, oefeningen, sets, gewichten en reps</li>
              <li><strong>Persoonlijke records:</strong> Je beste prestaties per oefening</li>
              <li><strong>Instellingen:</strong> App voorkeuren zoals rust timer duur en avatar</li>
              <li><strong>Technische data:</strong> Firebase Analytics voor app gebruik (anoniem)</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">🎯 Waarvoor we je data gebruiken</div>
            <ul class="info-list">
              <li>Om je workouts op te slaan en te synchroniseren tussen apparaten</li>
              <li>Om je persoonlijke records bij te houden en weer te geven</li>
              <li>Om je instellingen en voorkeuren te bewaren</li>
              <li>Om de app te verbeteren door anonieme gebruiksstatistieken</li>
              <li>Om je in te kunnen loggen op verschillende apparaten</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">🔐 Hoe we je data beschermen</div>
            <ul class="info-list">
              <li><strong>Encryptie:</strong> Alle data wordt via HTTPS verstuurd</li>
              <li><strong>Firebase Security:</strong> Strenge toegangsregels - alleen jij kan je eigen data zien</li>
              <li><strong>Geen tracking:</strong> We gebruiken geen advertentie-cookies of tracking van derden</li>
              <li><strong>Eigen data:</strong> Elke gebruiker heeft toegang tot alleen hun eigen informatie</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">🌍 Data opslag & locatie</div>
            <div class="info-text">
              Je data wordt opgeslagen in Firebase Firestore (Google Cloud). Firebase heeft datacenters wereldwijd en voldoet aan de AVG (GDPR) wetgeving voor Europese gebruikers.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">🍪 Cookies</div>
            <div class="info-text">
              De app gebruikt alleen essentiële cookies voor:
            </div>
            <ul class="info-list">
              <li><strong>Authenticatie:</strong> Om je ingelogd te houden</li>
              <li><strong>Lokale opslag:</strong> Voor offline functionaliteit en snellere laadtijden</li>
            </ul>
            <div class="info-text">
              We gebruiken <strong>geen</strong> advertentie-cookies of tracking cookies van derden.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">👤 Jouw rechten (AVG/GDPR)</div>
            <div class="info-text">Onder de AVG heb je de volgende rechten:</div>
            <ul class="info-list">
              <li><strong>Inzage:</strong> Je kunt al je data in de app bekijken</li>
              <li><strong>Correctie:</strong> Je kunt je gegevens zelf aanpassen in de app</li>
              <li><strong>Verwijdering:</strong> Log uit en je lokale data wordt verwijderd. Voor volledige accountverwijdering, neem contact op</li>
              <li><strong>Overdraagbaarheid:</strong> Je data is toegankelijk in een gestructureerd formaat</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">📤 Delen van data</div>
            <div class="info-text">
              We delen <strong>nooit</strong> je persoonlijke data met derden voor marketing doeleinden. Alleen de services die nodig zijn om de app te laten werken hebben toegang:
            </div>
            <ul class="info-list">
              <li><strong>Firebase/Google:</strong> Voor hosting en authenticatie</li>
              <li><strong>Vercel:</strong> Voor hosting van de website</li>
            </ul>
            <div class="info-text">
              Beide partijen zijn AVG-compliant.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">👶 Kinderen</div>
            <div class="info-text">
              Deze app is bedoeld voor gebruikers van 16 jaar en ouder. We verzamelen niet bewust gegevens van jongere gebruikers.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">🔄 Wijzigingen in dit beleid</div>
            <div class="info-text">
              We kunnen dit privacybeleid van tijd tot tijd bijwerken. Belangrijke wijzigingen worden in de app aangekondigd. De datum "Laatst bijgewerkt" bovenaan geeft aan wanneer dit beleid voor het laatst is aangepast.
            </div>
          </div>

          <div class="info-section" style="margin-bottom:0">
            <div class="info-title">📧 Contact</div>
            <div class="info-text">
              Heb je vragen over dit privacybeleid of wil je gebruik maken van je AVG-rechten? Open een issue op onze GitHub repository of gebruik de feedback functie in de app.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TERMS OF SERVICE MODAL -->
<div class="settings-overlay" id="terms-overlay" onclick="termsOverlayClick(event)">
  <div class="settings-sheet">
    <div class="settings-handle"></div>
    <div class="settings-hd">
      <button class="modal-close" onclick="closeTerms()" style="order:-1;margin-right:12px">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      </button>
      <div class="settings-title">📄 Gebruiksvoorwaarden</div>
      <div style="width:32px"></div>
    </div>
    <div class="settings-body">
      <div class="sett-card" style="margin-bottom:16px">
        <div style="padding:20px">
          <div class="info-text" style="font-size:12px;color:var(--g400);margin-bottom:16px">
            <strong>Laatst bijgewerkt:</strong> 24 februari 2025
          </div>

          <div class="info-section">
            <div class="info-title">👋 Welkom</div>
            <div class="info-text">
              Door de Basis-Fit Workout Tracker te gebruiken, ga je akkoord met deze gebruiksvoorwaarden. Lees ze zorgvuldig door. Als je niet akkoord gaat, gebruik de app dan niet.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">✅ Toegestaan gebruik</div>
            <div class="info-text">Je mag deze app gebruiken voor:</div>
            <ul class="info-list">
              <li>Het bijhouden van je persoonlijke trainingen en workouts</li>
              <li>Het maken en opslaan van trainingsschema's</li>
              <li>Het delen van je workout resultaten op social media</li>
              <li>Het synchroniseren van je data tussen meerdere apparaten</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">🚫 Niet toegestaan</div>
            <div class="info-text">Je mag de app <strong>niet</strong> gebruiken voor:</div>
            <ul class="info-list">
              <li>Illegale activiteiten of het schenden van rechten van anderen</li>
              <li>Het verspreiden van malware, virussen of schadelijke code</li>
              <li>Het proberen toegang te krijgen tot data van andere gebruikers</li>
              <li>Het overbelasten van onze servers door geautomatiseerde requests</li>
              <li>Het reverse-engineeren of kopiëren van de app voor commerciële doeleinden</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">🔑 Account & Beveiliging</div>
            <ul class="info-list">
              <li>Je bent verantwoordelijk voor het geheimhouden van je wachtwoord</li>
              <li>Je bent verantwoordelijk voor alle activiteiten onder jouw account</li>
              <li>Meld verdachte activiteiten onmiddellijk</li>
              <li>We kunnen accounts opschorten of verwijderen bij misbruik</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">💾 Je data</div>
            <ul class="info-list">
              <li><strong>Eigendom:</strong> Al je trainingsdata blijft van jou</li>
              <li><strong>Back-ups:</strong> We raden aan regelmatig je eigen back-ups te maken</li>
              <li><strong>Verwijdering:</strong> Bij uitloggen wordt lokale data verwijderd. Voor volledige verwijdering, neem contact op</li>
              <li><strong>Accuraatheid:</strong> We garanderen niet dat de app altijd foutloos werkt. Gebruik de app op eigen risico</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">⚠️ Disclaimer</div>
            <div class="info-text">
              <strong>Medisch advies:</strong> Deze app is een hulpmiddel voor workout tracking en vervangt geen professioneel medisch of sportadvies. Raadpleeg altijd een arts voordat je start met een nieuw trainingsprogramma, vooral bij bestaande medische condities.
            </div>
            <div class="info-text">
              <strong>Blessures:</strong> Wij zijn niet aansprakelijk voor blessures, ongevallen of schade ontstaan door het gebruik van deze app. Train altijd veilig en luister naar je lichaam.
            </div>
            <div class="info-text">
              <strong>"As-is":</strong> De app wordt aangeboden zoals deze is, zonder garanties. We garanderen niet dat de app altijd beschikbaar of foutloos is.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">🔄 Beschikbaarheid & Updates</div>
            <ul class="info-list">
              <li>We doen ons best de app 24/7 beschikbaar te houden, maar garanderen dit niet</li>
              <li>We kunnen de app tijdelijk offline halen voor onderhoud</li>
              <li>We kunnen features toevoegen, wijzigen of verwijderen</li>
              <li>Updates kunnen automatisch worden geïnstalleerd</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">🏢 Intellectueel eigendom</div>
            <div class="info-text">
              Alle rechten op de app, inclusief design, code, logo's en content blijven eigendom van de maker. Je krijgt alleen een persoonlijk, niet-overdraagbaar gebruiksrecht.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">📤 Gedeelde content</div>
            <div class="info-text">
              Als je workouts deelt via de app (bijv. naar Instagram), blijf je eigenaar van die content. Wij claimen geen rechten op je gedeelde workout images.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">⚖️ Aansprakelijkheid</div>
            <div class="info-text">
              We zijn niet aansprakelijk voor:
            </div>
            <ul class="info-list">
              <li>Verlies van data door technische problemen</li>
              <li>Schade door verkeerd gebruik van de app</li>
              <li>Blessures of gezondheidsschade</li>
              <li>Indirecte schade of gederfde winst</li>
            </ul>
          </div>

          <div class="info-section">
            <div class="info-title">🔧 Wijzigingen in voorwaarden</div>
            <div class="info-text">
              We kunnen deze voorwaarden op elk moment wijzigen. Belangrijke wijzigingen worden in de app aangekondigd. Voortgezet gebruik na wijzigingen betekent dat je akkoord gaat met de nieuwe voorwaarden.
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">⚖️ Nederlands recht</div>
            <div class="info-text">
              Deze voorwaarden vallen onder Nederlands recht. Eventuele geschillen worden voorgelegd aan de bevoegde rechter in Nederland.
            </div>
          </div>

          <div class="info-section" style="margin-bottom:0">
            <div class="info-title">📧 Contact</div>
            <div class="info-text">
              Vragen over deze voorwaarden? Open een issue op onze GitHub repository of gebruik de feedback functie in de app.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="share-overlay" id="share-overlay">
  <div class="share-sheet">
    <div class="share-sheet-hd">
      <div class="share-sheet-title">📤 Workout delen</div>
      <button class="modal-close" onclick="closeShare()">✕</button>
    </div>

    <!-- Canvas preview -->
    <div class="share-canvas-wrap" id="share-canvas-wrap">
      <canvas id="share-canvas-cv" width="1080" height="1920"></canvas>
      <div class="canvas-loading" id="canvas-loading"><div class="canvas-spinner"></div></div>
    </div>

    <!-- Background picker -->
    <div class="share-bg-section">
      <span class="share-bg-label">Achtergrond</span>
      <div class="share-bg-pills">
        <button class="bg-pill active" id="bg-pill-default" onclick="setBgDefault()">
          <svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 0 18A9 9 0 0 0 12 3zm0 16a7 7 0 1 1 0-14A7 7 0 0 1 12 19zm0-11a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm6 9.3c-.9-1.4-2.6-2.3-4.5-2.3H10.5c-1.9 0-3.6.9-4.5 2.3a7.02 7.02 0 0 0 12 0z"/></svg>
          Standaard
        </button>
        <button class="bg-pill" id="bg-pill-photo" onclick="pickBgPhoto()">
          <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
          Foto kiezen
        </button>
        <button class="bg-pill" id="bg-pill-camera" onclick="takeBgPhoto()">
          <svg viewBox="0 0 24 24"><path d="M12 15.2A3.2 3.2 0 0 1 8.8 12 3.2 3.2 0 0 1 12 8.8 3.2 3.2 0 0 1 15.2 12 3.2 3.2 0 0 1 12 15.2M12 7a5 5 0 0 0-5 5 5 5 0 0 0 5 5 5 5 0 0 0 5-5 5 5 0 0 0-5-5m0-1a1 1 0 0 0-1-1h-2l-1.83-2H7C5.9 3 5 3.9 5 5v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-2.17L13 3h-2c-.55 0-1 .45-1 1z"/></svg>
          Camera
        </button>
      </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="bg-file-gallery" accept="image/*" style="display:none" onchange="handleBgFile(this)">
    <input type="file" id="bg-file-camera" accept="image/*" capture="environment" style="display:none" onchange="handleBgFile(this)">

    <!-- Share buttons -->
    <div class="share-btns-section">
      <!-- Instagram Stories -->
      <button class="btn-share-ig" onclick="shareToInstagram()">
        <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        Delen via Instagram Stories
      </button>
      <p class="ig-tip" id="ig-tip">Afbeelding wordt opgeslagen — open Instagram en voeg toe aan je Story</p>

      <!-- Save + Generic share -->
      <div class="share-btns-row">
        <button class="btn-share-action btn-share-dl" onclick="downloadShare()">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          Opslaan
        </button>
        <button class="btn-share-action btn-share-native" id="btn-share-native" onclick="nativeShare()">
          <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
          Meer opties
        </button>
      </div>
    </div>
  </div>
</div>

<div class="rest-timer" id="rest-timer">
  <span>⏱ Rust</span>
  <span id="rest-timer-txt">1:30</span>
  <div class="rest-timer-bar"><div class="rest-timer-fill" id="rest-timer-fill" style="width:100%"></div></div>
</div>
<div class="sync-dot" id="sync-dot" title="Data sync"></div>
<div class="toast" id="toast"></div>
<canvas id="confetti-cv"></canvas>
</div><!-- #app -->

<script>
/* ══════════════════════════════════════
   QUOTES
══════════════════════════════════════ */
const QUOTES = [
  'Train slim, train hard 💥',
  'Jij vs. jij van gisteren 🏆',
  'Geen excuses, wel resultaat 🔥',
  'De pijn van vandaag is de kracht van morgen 💪',
  'Elke rep telt. Elke dag telt. ⚡',
  'Progressie, niet perfectie 📈',
  'Je lichaam houdt meer bij dan jij denkt 🧠',
  'Doe het voor de persoon die je wil worden 🚀',
  'Rust is verdiend. Ga verdienen. 😤',
  'Sterk zijn is een keuze die je elke dag maakt 💡',
  'De set die je wil overslaan is de set die telt 🎯',
  'Je bent dichter bij je doel dan gisteren 📍',
  'Discipline is vrijheid 🔓',
  'Zweet nu, schitteren later ✨',
  'Morgen begin je niet, vandaag begin je 📅',
  'Kleine verbeteringen, grote resultaten ⚙️',
  'De gym roept. Gehoor geven. 🏋️',
  'Je eigen beste concurrent ben jezelf 🪞',
  'Zo moeilijk als het voelt, zo trots voel je je daarna 🌅',
  'Eén rep meer dan vorige week — dat is alles ➕',
  'Je tank is leger dan je denkt — je kan toch 🔋',
  'Winnaars trainen ook als ze geen zin hebben 🥇',
  'Leg de telefoon weg en til het gewicht op 📵',
  'Elke workout is een investering in je toekomst 💰',
  'Jij bent sterker dan je excuses 🌟',
];

let quoteIdx = Math.floor(Math.random() * QUOTES.length);
let quoteTimer = null;

function startQuoteCycle() {
  if (quoteTimer) clearInterval(quoteTimer);
  quoteTimer = setInterval(() => {
    const el = document.getElementById('greet-sub');
    if (!el) return;
    el.style.animation = 'quoteOut .3s ease forwards';
    setTimeout(() => {
      quoteIdx = (quoteIdx + 1) % QUOTES.length;
      el.textContent = QUOTES[quoteIdx];
      el.style.animation = 'quoteIn .4s ease forwards';
    }, 300);
  }, 10000);
}

/* ══════════════════════════════════════
   WAKE LOCK — scherm actief houden
══════════════════════════════════════ */
let wakeLock = null;

async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      document.getElementById('wakelock-badge').classList.add('active');
      wakeLock.addEventListener('release', () => {
        document.getElementById('wakelock-badge').classList.remove('active');
      });
    }
  } catch (e) { console.warn('WakeLock niet beschikbaar:', e.message); }
}

function releaseWakeLock() {
  if (wakeLock) { wakeLock.release().catch(() => {}); wakeLock = null; }
  const badge = document.getElementById('wakelock-badge');
  if (badge) badge.classList.remove('active');
}

// Heractiveer wake lock + herstel timer wanneer app weer zichtbaar wordt
document.addEventListener('visibilitychange', async () => {
  if (document.visibilityState === 'visible') {
    if (workout) await requestWakeLock();
    // Herstel rest timer op basis van opgeslagen eindtijd
    const savedEnd = LS.get('bf_restEnd', 0);
    const savedTotal = LS.get('bf_restTotal', 90);
    if (savedEnd && savedEnd > Date.now()) {
      const remaining = Math.ceil((savedEnd - Date.now()) / 1000);
      // Herstart de tick zonder opnieuw te schedulen
      restEndTime = savedEnd;
      restDurationTotal = savedTotal;
      const el = document.getElementById('rest-timer');
      const fill = document.getElementById('rest-timer-fill');
      const txt = document.getElementById('rest-timer-txt');
      if (el && !restInterval) {
        el.classList.add('show');
        restInterval = setInterval(() => {
          const rem = Math.max(0, Math.ceil((restEndTime - Date.now()) / 1000));
          const m = Math.floor(rem / 60), s = rem % 60;
          if (txt) txt.textContent = m + ':' + String(s).padStart(2, '0');
          if (fill) fill.style.width = ((rem / restDurationTotal) * 100) + '%';
          if (rem <= 0) {
            clearInterval(restInterval); restInterval = null;
            el.classList.remove('show');
            LS.set('bf_restEnd', 0);
            toast('✅ Rust voorbij — next set!');
            showInAppNotification('⏱ Rust voorbij!', 'Tijd voor je volgende set 💪');
          }
        }, 500);
      }
    } else if (savedEnd && savedEnd <= Date.now()) {
      // Timer is verlopen terwijl app op achtergrond was
      LS.set('bf_restEnd', 0);
      if (workout) {
        toast('⏱ Rust voorbij — next set!');
        showInAppNotification('⏱ Rust voorbij!', 'Klaar voor de volgende set? 💪');
      }
    }
  }
});

/* ══════════════════════════════════════
   SHARE — workout kaart genereren
══════════════════════════════════════ */
let shareSession = null;
let shareBgImage = null; // custom achtergrond afbeelding

function openShare(session) {
  shareSession = session;
  shareBgImage = null;
  setBgPillActive('default');
  document.getElementById('share-overlay').classList.add('open');
  if (!navigator.share) {
    document.getElementById('btn-share-native').classList.add('hidden');
  }
  setTimeout(() => generateShareCard(session), 80);
}

function closeShare() {
  document.getElementById('share-overlay').classList.remove('open');
  // Reset file inputs so same file can be re-selected
  document.getElementById('bg-file-gallery').value = '';
  document.getElementById('bg-file-camera').value = '';
}

// ── Background picker helpers ──
function setBgPillActive(type) {
  ['default','photo','camera'].forEach(t => {
    document.getElementById('bg-pill-' + t).classList.toggle('active', t === type);
  });
}

function setBgDefault() {
  shareBgImage = null;
  setBgPillActive('default');
  generateShareCard(shareSession);
}

function pickBgPhoto() {
  document.getElementById('bg-file-gallery').click();
}

function takeBgPhoto() {
  document.getElementById('bg-file-camera').click();
}

function handleBgFile(input) {
  const file = input.files && input.files[0];
  if (!file) return;
  setBgPillActive(input.id === 'bg-file-camera' ? 'camera' : 'photo');
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      shareBgImage = img;
      generateShareCard(shareSession);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ── Instagram sharing ──
async function shareToInstagram() {
  showCanvasLoading(true);
  const cv = document.getElementById('share-canvas-cv');
  cv.toBlob(async (blob) => {
    showCanvasLoading(false);
    const file = new File([blob], 'basis-fit-workout.png', { type: 'image/png' });
    // Try Web Share API with files (works on iOS Safari / Android Chrome → can target Instagram)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          files: [file],
          title: 'Mijn Basis Fit workout 💪',
          text: '#BasisFit #Training #Workout',
        });
        return;
      } catch (e) {
        if (e.name === 'AbortError') return;
      }
    }
    // Fallback: save to device and instruct user
    const link = document.createElement('a');
    link.download = 'basis-fit-workout.png';
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
    const tip = document.getElementById('ig-tip');
    if (tip) {
      tip.style.color = 'var(--accent)';
      tip.style.fontWeight = '600';
      tip.textContent = '✅ Opgeslagen! Open Instagram → + → Story → Foto → selecteer de afbeelding';
      setTimeout(() => {
        tip.style.color = ''; tip.style.fontWeight = '';
        tip.textContent = 'Afbeelding wordt opgeslagen — open Instagram en voeg toe aan je Story';
      }, 6000);
    }
  }, 'image/png');
}

function showCanvasLoading(on) {
  const el = document.getElementById('canvas-loading');
  if (el) el.classList.toggle('show', on);
}

function generateShareCard(session) {
  const cv = document.getElementById('share-canvas-cv');
  const cx = cv.getContext('2d');
  const W = 1080, H = 1920;
  cx.clearRect(0, 0, W, H);

  // ── Achtergrond ──
  if (shareBgImage) {
    // Draw custom photo as background (cover)
    const imgAR = shareBgImage.width / shareBgImage.height;
    const cvAR  = W / H;
    let sx = 0, sy = 0, sw = shareBgImage.width, sh = shareBgImage.height;
    if (imgAR > cvAR) {
      sw = shareBgImage.height * cvAR;
      sx = (shareBgImage.width - sw) / 2;
    } else {
      sh = shareBgImage.width / cvAR;
      sy = (shareBgImage.height - sh) / 2;
    }
    cx.drawImage(shareBgImage, sx, sy, sw, sh, 0, 0, W, H);
    // Dark overlay for readability
    const overlay = cx.createLinearGradient(0, 0, 0, H);
    overlay.addColorStop(0, 'rgba(10,15,25,.72)');
    overlay.addColorStop(0.5, 'rgba(10,15,25,.60)');
    overlay.addColorStop(1, 'rgba(10,15,25,.85)');
    cx.fillStyle = overlay;
    cx.fillRect(0, 0, W, H);
  } else {
    // Default gradient background
    const bg = cx.createLinearGradient(0, 0, W, H);
    bg.addColorStop(0, '#1B2735');
    bg.addColorStop(0.55, '#23395B');
    bg.addColorStop(1, '#0f1a27');
    cx.fillStyle = bg;
    cx.fillRect(0, 0, W, H);

    // ── Decoratieve cirkels (alleen bij standaard bg) ──
    cx.save();
    cx.globalAlpha = 0.09;
    cx.fillStyle = '#4A90D9';
    cx.beginPath(); cx.arc(W * 0.78, H * 0.25, 520, 0, Math.PI * 2); cx.fill();
    cx.globalAlpha = 0.06;
    cx.fillStyle = '#27C47A';
    cx.beginPath(); cx.arc(W * 0.18, H * 0.72, 400, 0, Math.PI * 2); cx.fill();
    cx.restore();
  }


  // ── BRANDING HEADER ──
  const hdrY = 88;
  cx.fillStyle = '#4A90D9';
  roundRect(cx, 80, hdrY, 96, 96, 26);
  cx.fillStyle = '#fff';
  cx.font = 'bold 52px Arial';
  cx.textAlign = 'center';
  cx.fillText('⚡', 128, hdrY + 68);

  cx.fillStyle = '#fff';
  cx.font = 'bold 52px "Syne", Arial';
  cx.textAlign = 'left';
  cx.fillText('BASIS FIT', 206, hdrY + 42);
  cx.font = '500 34px "DM Sans", Arial';
  cx.fillStyle = 'rgba(255,255,255,0.5)';
  const dateStr = session ? new Date(session.date).toLocaleDateString('nl-NL', {weekday:'long', day:'numeric', month:'long'}) : new Date().toLocaleDateString('nl-NL', {weekday:'long', day:'numeric', month:'long'});
  cx.fillText(capitalize(dateStr), 206, hdrY + 82);

  // ── Divider ──
  cx.fillStyle = 'rgba(255,255,255,0.1)';
  cx.fillRect(80, 224, W - 160, 1.5);

  // ── TRAINING NAAM ──
  const progName = session ? session.programName : '—';
  cx.fillStyle = 'rgba(255,255,255,0.5)';
  cx.font = '700 26px "DM Sans", Arial';
  cx.letterSpacing = '6px';
  cx.fillText('TRAINING', 80, 300);
  cx.letterSpacing = '0px';
  cx.fillStyle = '#fff';
  cx.font = 'bold 68px "Syne", Arial';
  cx.fillText(progName, 80, 388);

  // ── VOLUME MEGA DISPLAY ──
  const totalVol = session ? calcTotalVolume(session.exercises) : 0;
  const volStr = totalVol >= 1000 ? (totalVol / 1000).toFixed(1) + ' ton' : totalVol.toLocaleString('nl-NL') + ' kg';

  cx.fillStyle = 'rgba(74,144,217,0.2)';
  roundRect(cx, 80, 420, W - 160, 260, 44);

  drawDumbbell(cx, 140, 558, 76, 'rgba(74,144,217,0.7)');

  cx.fillStyle = '#4A90D9';
  cx.font = '700 26px "DM Sans", Arial';
  cx.textAlign = 'left';
  cx.fillText('TOTAAL VOLUME', 250, 500);
  cx.fillStyle = '#fff';
  cx.font = 'bold 116px "Syne", Arial';
  cx.fillText(volStr, 250, 636);

  // ── STATISTIEKEN ──
  const exercises = session ? session.exercises : [];
  const totalSetsCount = exercises.reduce((s, ex) => s + ex.sets, 0);
  const maxWeight = exercises.reduce((m, ex) => Math.max(m, ex.bestWeight || 0), 0);

  const stats = [
    { icon: '🔁', label: 'Sets', value: String(totalSetsCount) },
    { icon: '🏋️', label: 'Max kg', value: maxWeight + ' kg' },
    { icon: '💪', label: 'Oefeningen', value: String(exercises.length) },
  ];

  const statY = 730;
  const statW = (W - 160 - 40) / 3;
  stats.forEach((s, i) => {
    const sx = 80 + i * (statW + 20);
    cx.fillStyle = 'rgba(255,255,255,0.09)';
    roundRect(cx, sx, statY, statW, 172, 32);
    cx.fillStyle = 'rgba(255,255,255,0.7)';
    cx.font = '44px Arial';
    cx.textAlign = 'center';
    cx.fillText(s.icon, sx + statW / 2, statY + 62);
    cx.fillStyle = '#fff';
    cx.font = 'bold 44px "DM Mono", monospace, Arial';
    cx.fillText(s.value, sx + statW / 2, statY + 114);
    cx.fillStyle = 'rgba(255,255,255,0.4)';
    cx.font = '500 22px "DM Sans", Arial';
    cx.fillText(s.label, sx + statW / 2, statY + 148);
  });

  // ── OEFENINGEN LIJST ──
  cx.fillStyle = 'rgba(255,255,255,0.1)';
  cx.fillRect(80, 942, W - 160, 1.5);

  cx.fillStyle = 'rgba(255,255,255,0.45)';
  cx.font = '700 24px "DM Sans", Arial';
  cx.textAlign = 'left';
  cx.letterSpacing = '4px';
  cx.fillText('GEDAAN VANDAAG', 80, 1000);
  cx.letterSpacing = '0px';

  const exToShow = exercises.slice(0, 7);
  exToShow.forEach((ex, i) => {
    const ey = 1038 + i * 100;
    cx.fillStyle = i % 2 === 0 ? 'rgba(255,255,255,0.06)' : 'transparent';
    roundRect(cx, 80, ey - 16, W - 160, 84, 20);
    cx.fillStyle = '#4A90D9';
    cx.beginPath(); cx.arc(114, ey + 24, 8, 0, Math.PI * 2); cx.fill();
    cx.fillStyle = '#fff';
    cx.font = '500 32px "DM Sans", Arial';
    cx.textAlign = 'left';
    const nameText = ex.name.length > 30 ? ex.name.substring(0, 29) + '…' : ex.name;
    cx.fillText(nameText, 142, ey + 32);
    cx.fillStyle = 'rgba(255,255,255,0.5)';
    cx.font = '500 28px "DM Mono", monospace, Arial';
    cx.textAlign = 'right';
    cx.fillText(`${ex.bestWeight}kg × ${ex.bestReps} · ${ex.sets}×`, W - 80, ey + 32);
  });
  if (exercises.length > 7) {
    cx.fillStyle = 'rgba(255,255,255,0.35)';
    cx.font = '500 26px "DM Sans", Arial';
    cx.textAlign = 'center';
    cx.fillText(`+ ${exercises.length - 7} meer oefeningen`, W / 2, 1038 + 7 * 100 + 8);
  }

  // ── FOOTER ──
  cx.fillStyle = 'rgba(255,255,255,0.12)';
  cx.fillRect(80, H - 180, W - 160, 1.5);
  cx.fillStyle = 'rgba(255,255,255,0.3)';
  cx.font = '500 28px "DM Sans", Arial';
  cx.textAlign = 'center';
  cx.fillText('basis-fit.app  ·  Train slim, train hard 💪', W / 2, H - 116);
  cx.fillStyle = 'rgba(74,144,217,0.9)';
  cx.font = 'bold 26px "DM Sans", Arial';
  cx.fillText('Wat is jouw volume? 🏆', W / 2, H - 72);
}

function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

function calcTotalVolume(exercises) {
  return exercises.reduce((total, ex) => {
    // bestWeight × bestReps × sets als schatting
    return total + (parseFloat(ex.bestWeight) || 0) * (parseInt(ex.bestReps) || 0) * (parseInt(ex.sets) || 1);
  }, 0);
}

function roundRect(cx, x, y, w, h, r) {
  cx.beginPath();
  cx.moveTo(x + r, y);
  cx.lineTo(x + w - r, y);
  cx.quadraticCurveTo(x + w, y, x + w, y + r);
  cx.lineTo(x + w, y + h - r);
  cx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  cx.lineTo(x + r, y + h);
  cx.quadraticCurveTo(x, y + h, x, y + h - r);
  cx.lineTo(x, y + r);
  cx.quadraticCurveTo(x, y, x + r, y);
  cx.closePath();
  cx.fill();
}

function drawDumbbell(cx, x, y, size, color) {
  cx.fillStyle = color;
  const s = size;
  // Linker gewicht
  roundRect(cx, x - s * 0.1, y - s * 0.42, s * 0.22, s * 0.84, 8);
  // Stang
  cx.fillRect(x + s * 0.12, y - s * 0.1, s * 0.76, s * 0.2);
  // Rechter gewicht
  roundRect(cx, x + s * 0.88, y - s * 0.42, s * 0.22, s * 0.84, 8);
}

function downloadShare() {
  showCanvasLoading(true);
  const cv = document.getElementById('share-canvas-cv');
  cv.toBlob((blob) => {
    showCanvasLoading(false);
    const link = document.createElement('a');
    link.download = 'basis-fit-workout.png';
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
  }, 'image/png');
}

async function nativeShare() {
  showCanvasLoading(true);
  const cv = document.getElementById('share-canvas-cv');
  cv.toBlob(async (blob) => {
    showCanvasLoading(false);
    const file = new File([blob], 'basis-fit-workout.png', { type: 'image/png' });
    try {
      await navigator.share({
        files: [file],
        title: 'Mijn Basis Fit workout 💪',
        text: `Check mijn workout! 🔥 #BasisFit #Training`,
      });
    } catch (e) {
      if (e.name !== 'AbortError') toast('Delen mislukt, sla op als alternatief');
    }
  }, 'image/png');
}


function openNameModal() {
  document.getElementById('inp-name-edit').value = getUser() || '';
  document.getElementById('name-modal').classList.add('open');
  setTimeout(() => document.getElementById('inp-name-edit').focus(), 350);
}
function closeNameModal() {
  document.getElementById('name-modal').classList.remove('open');
}
function saveName() {
  const n = document.getElementById('inp-name-edit').value.trim();
  if (!n) { toast('Vul een naam in'); return; }
  setUser(n);
  closeNameModal();
  renderHome();
  toast('✅ Naam opgeslagen!');
}

/* ══════════════════════════════════════
   SETTINGS
══════════════════════════════════════ */
const AVATAR_EMOJIS = ['💪','🔥','🦵','⚡','🏋️','🎯','💥','🚀','🧠','🫁','🏃','🥊','🦁','🐺','👊','🌟','🏆','⚔️','🦅','🤸'];
const TIMER_OPTS = [
  {label:'30s',val:30},{label:'45s',val:45},{label:'1 min',val:60},
  {label:'1:30',val:90},{label:'2 min',val:120},{label:'3 min',val:180},
  {label:'4 min',val:240},{label:'5 min',val:300},
];

function openSettings() {
  renderSettingsBody();
  document.getElementById('settings-overlay').classList.add('open');
}
function closeSettings() {
  document.getElementById('settings-overlay').classList.remove('open');
}
function settingsOverlayClick(e) {
  if (e.target === document.getElementById('settings-overlay')) closeSettings();
}

/* ══════════════════════════════════════
   LEGAL PAGES & INFO
══════════════════════════════════════ */
function showAbout() {
  closeSettings();
  setTimeout(() => {
    document.getElementById('about-overlay').classList.add('open');
  }, 100);
}
function closeAbout() {
  document.getElementById('about-overlay').classList.remove('open');
  setTimeout(() => {
    openSettings();
  }, 100);
}
function aboutOverlayClick(e) {
  if (e.target === document.getElementById('about-overlay')) closeAbout();
}

function showPrivacy() {
  closeSettings();
  setTimeout(() => {
    document.getElementById('privacy-overlay').classList.add('open');
  }, 100);
}
function closePrivacy() {
  document.getElementById('privacy-overlay').classList.remove('open');
  setTimeout(() => {
    openSettings();
  }, 100);
}
function privacyOverlayClick(e) {
  if (e.target === document.getElementById('privacy-overlay')) closePrivacy();
}

function showTerms() {
  closeSettings();
  setTimeout(() => {
    document.getElementById('terms-overlay').classList.add('open');
  }, 100);
}
function closeTerms() {
  document.getElementById('terms-overlay').classList.remove('open');
  setTimeout(() => {
    openSettings();
  }, 100);
}
function termsOverlayClick(e) {
  if (e.target === document.getElementById('terms-overlay')) closeTerms();
}

function renderSettingsBody() {
  const s = getSettings();
  const user = getUser() || '';
  const notifSupported = 'Notification' in window;
  const notifPerm = notifSupported ? Notification.permission : 'denied';

  document.getElementById('settings-body').innerHTML = `
    <div class="sett-section">
      <span class="sett-section-lbl">Profiel</span>
      <div class="sett-card">
        <div class="sett-row" style="gap:14px;padding:16px;align-items:flex-start">
          <div class="profile-avatar" style="font-size:32px;width:64px;height:64px;border-radius:18px;background:var(--navy);display:flex;align-items:center;justify-content:center;flex-shrink:0" id="sett-avatar-preview">${s.avatarEmoji}</div>
          <div style="flex:1;min-width:0">
            <div class="sett-row-label" style="margin-bottom:8px">Naam wijzigen</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="sett-name-inp" class="inp-light" type="text" placeholder="Naam…" maxlength="30" value="${esc(user)}" style="flex:1;padding:10px 12px;font-size:14px"/>
              <button class="btn-add" onclick="settSaveName()" style="padding:10px 14px;border-radius:9px;flex-shrink:0">✓</button>
            </div>
          </div>
        </div>
        <div style="padding:0 16px 6px">
          <div style="font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--g400);margin-bottom:8px">Avatar kiezen</div>
        </div>
        <div class="avatar-emoji-grid">
          ${AVATAR_EMOJIS.map(em => `<div class="avatar-opt${em===s.avatarEmoji?' picked':''}" onclick="settPickAvatar('${em}',this)">${em}</div>`).join('')}
        </div>
      </div>
    </div>

    <div class="sett-section">
      <span class="sett-section-lbl">Rust timer duur</span>
      <div class="sett-card">
        <div class="timer-pills">
          ${TIMER_OPTS.map(o=>`<button class="timer-pill${o.val===s.restDuration&&!s.customTimer?' sel':''}" onclick="settPickTimer(${o.val},this)">${o.label}</button>`).join('')}
        </div>
        <div class="timer-custom-row">
          <span class="timer-custom-lbl">⌛ Eigen tijd:</span>
          <input class="timer-custom-inp" id="custom-timer-inp" type="number" min="10" max="600"
            placeholder="${s.customTimer||''}"
            value="${s.customTimer||''}"
            inputmode="numeric"/>
          <span class="timer-custom-lbl">sec</span>
          <button class="btn-add" onclick="settPickCustomTimer()" style="padding:10px 14px;border-radius:9px;flex-shrink:0;margin-left:auto">Sla op</button>
        </div>
        ${s.customTimer ? `<div style="padding:0 16px 12px;font-size:12px;color:var(--accent);font-weight:600">✓ Eigen timer actief: ${s.customTimer}s (${Math.floor(s.customTimer/60)}:${String(s.customTimer%60).padStart(2,'0')})</div>` : ''}
      </div>
    </div>

    <div class="sett-section">
      <span class="sett-section-lbl">Meldingen</span>
      <div class="sett-card">
        <div class="sett-row">
          <div class="sett-row-icon"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg></div>
          <div class="sett-row-info">
            <div class="sett-row-label">Timer melding</div>
            <div class="sett-row-sub">${!notifSupported?'Niet ondersteund':notifPerm==='denied'?'Geblokkeerd in browserinst.':notifPerm==='granted'?'Melding als rust voorbij is':'Toestemming vereist'}</div>
          </div>
          <label class="toggle-wrap" ${!notifSupported||notifPerm==='denied'?'style="opacity:.4;pointer-events:none"':''}>
            <input type="checkbox" class="toggle-inp" id="notif-toggle" ${s.notificationsOn?'checked':''} onchange="settToggleNotif(this)"/>
            <span class="toggle-track"></span>
          </label>
        </div>
        ${notifSupported&&notifPerm==='default'?`
        <div style="padding:4px 16px 14px">
          <button class="btn-add" style="width:100%;padding:12px;border-radius:10px;font-size:14px" onclick="settRequestNotif()">📲 Toestemming vragen</button>
        </div>`:''}
      </div>
    </div>

    <!-- Info & Documentatie -->
    <div class="sett-section">
      <span class="sett-section-lbl">Info & Documentatie</span>
      <div class="sett-card">
        <div class="sett-row" onclick="showAbout()" style="cursor:pointer">
          <div class="sett-row-icon">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
          </div>
          <div class="sett-row-info">
            <div class="sett-row-label">Over Basis-Fit App</div>
            <div class="sett-row-sub">Versie, features & informatie</div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="var(--g400)"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </div>
        <div class="sett-row" onclick="showPrivacy()" style="cursor:pointer">
          <div class="sett-row-icon">
            <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
          </div>
          <div class="sett-row-info">
            <div class="sett-row-label">Privacybeleid</div>
            <div class="sett-row-sub">Hoe we met je data omgaan</div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="var(--g400)"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </div>
        <div class="sett-row" onclick="showTerms()" style="cursor:pointer;border-bottom:none">
          <div class="sett-row-icon">
            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
          </div>
          <div class="sett-row-info">
            <div class="sett-row-label">Gebruiksvoorwaarden</div>
            <div class="sett-row-sub">Voorwaarden voor gebruik</div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="var(--g400)"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </div>
      </div>
    </div>

    <!-- Account / uitloggen -->
    <div class="sett-section">
      <span class="sett-section-lbl">Account</span>
      <div class="sett-card">
        <div class="sett-row">
          <div class="sett-row-icon" style="background:var(--redbg)">
            <svg viewBox="0 0 24 24" style="fill:var(--red)"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
          </div>
          <div class="sett-row-info">
            <div class="sett-row-label">Uitloggen</div>
            <div class="sett-row-sub">Data wordt gesynchroniseerd op alle apparaten</div>
          </div>
          <button onclick="signOutUser()" style="background:var(--redbg);border:1px solid rgba(232,69,60,.2);color:var(--red);border-radius:10px;padding:8px 14px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;flex-shrink:0;white-space:nowrap">Uitloggen</button>
        </div>
      </div>
    </div>

    <!-- App Info Footer -->
    <div style="padding:16px 4px;text-align:center">
      <div style="font-size:12px;color:var(--g400);margin-bottom:6px">Basis-Fit Workout Tracker</div>
      <div class="version-badge">v1.0.0</div>
      <div style="font-size:11px;color:var(--g400);margin-top:10px">© 2025 · Gemaakt met 💪 in Nederland</div>
    </div>
    <div style="height:8px"></div>
  `;
}

function settSaveName() {
  const n = document.getElementById('sett-name-inp').value.trim();
  if (!n) { toast('Vul een naam in'); return; }
  setUser(n);
  renderHome();
  toast('✅ Naam opgeslagen!');
}
function settPickAvatar(emoji, el) {
  const s = getSettings(); s.avatarEmoji = emoji; saveSettings(s);
  document.querySelectorAll('#settings-body .avatar-opt').forEach(o=>o.classList.remove('picked'));
  el.classList.add('picked');
  const prev = document.getElementById('sett-avatar-preview');
  if (prev) prev.textContent = emoji;
  renderHome();
}
function settPickTimer(val, el) {
  const s = getSettings();
  s.restDuration = val;
  s.customTimer = null; // preset gekozen, custom wissen
  saveSettings(s);
  document.querySelectorAll('.timer-pill').forEach(p=>p.classList.remove('sel'));
  el.classList.add('sel');
  // Clear custom input
  const ci = document.getElementById('custom-timer-inp');
  if (ci) ci.value = '';
  const hint = document.querySelector('.timer-custom-hint');
  if (hint) hint.remove();
  renderSettingsBody(); // herrender om de "actief" tekst te verbergen
  toast('⏱ Rusttimer: ' + TIMER_OPTS.find(o=>o.val===val)?.label);
}
function settPickCustomTimer() {
  const inp = document.getElementById('custom-timer-inp');
  const val = parseInt(inp?.value);
  if (!val || val < 10 || val > 600) { toast('Vul een tijd in (10–600 sec)'); return; }
  const s = getSettings();
  s.restDuration = val;
  s.customTimer = val;
  saveSettings(s);
  // Deselecteer alle presets
  document.querySelectorAll('.timer-pill').forEach(p=>p.classList.remove('sel'));
  const mins = Math.floor(val/60), secs = val%60;
  const label = mins > 0 ? mins+'m'+( secs ? ' '+secs+'s' : '') : val+'s';
  toast('⏱ Eigen timer: ' + label);
  renderSettingsBody();
}
async function settToggleNotif(checkbox) {
  const s = getSettings();
  if (checkbox.checked && Notification.permission !== 'granted') {
    const granted = await requestNotificationPermission();
    if (!granted) { checkbox.checked = false; toast('Meldingen niet toegestaan'); renderSettingsBody(); return; }
  }
  s.notificationsOn = checkbox.checked; saveSettings(s);
  toast(checkbox.checked ? '🔔 Meldingen aan' : '🔕 Meldingen uit');
}
async function settRequestNotif() {
  const granted = await requestNotificationPermission();
  if (granted) {
    const s = getSettings(); s.notificationsOn = true; saveSettings(s);
    toast('🔔 Meldingen ingeschakeld!'); renderSettingsBody();
  } else { toast('Sta meldingen toe in browserinstellingen'); }
}



/* ══════════════════════════════════════
   RIPPLE
══════════════════════════════════════ */
function addRipple(e) {
  const btn = e.currentTarget;
  const rect = btn.getBoundingClientRect();
  const size = Math.max(rect.width, rect.height);
  const cx = e.clientX ?? rect.left + rect.width / 2;
  const cy = e.clientY ?? rect.top + rect.height / 2;
  const r = document.createElement('span');
  r.className = 'ripple';
  r.style.cssText = 'width:'+size+'px;height:'+size+'px;left:'+(cx-rect.left-size/2)+'px;top:'+(cy-rect.top-size/2)+'px';
  btn.appendChild(r);
  r.addEventListener('animationend', () => r.remove());
}
function attachRipples() {
  document.querySelectorAll('.btn-start,.btn-finish,.btn-primary').forEach(btn => {
    btn.addEventListener('mousedown', addRipple);
    btn.addEventListener('touchstart', addRipple, { passive: true });
  });
}

/* ══════════════════════════════════════
   MACHINE LIBRARY
══════════════════════════════════════ */
const MG = {
  'Benen': ['Leg press (horizontaal)','Leg press (45°)','Hack squat machine','Leg extension','Seated leg curl','Lying leg curl','Standing leg curl','Hip abductor machine','Hip adductor machine','Glute machine / kickback','Calf raise (seated)','Calf raise (standing)','Smith machine'],
  'Borst': ['Chest press machine','Incline chest press','Decline chest press','Pec deck / chest fly'],
  'Rug': ['Lat pulldown','Seated row machine','High row / vertical row','Assisted pull-up machine','Assisted dip machine','Pullover machine'],
  'Schouders': ['Shoulder press machine','Lateral raise machine','Rear delt / reverse fly machine'],
  'Armen': ['Biceps curl machine','Triceps extension machine','Dip machine','Cable station'],
  'Core': ['Abdominal crunch machine','Rotary torso machine','Back extension machine','Roman chair / hyperextension'],
  'Vrij gewicht': ['Barbell squat','Barbell deadlift','Barbell bench press','Barbell row','Barbell shoulder press','Dumbbell curl','Dumbbell press','Dumbbell lateral raise','Pull-ups','Dips (lichaamsgewicht)'],
  'Functioneel': ['Cable crossover','Multi-gym station','Smith + rack combinatie'],
};

const DEFAULT_PROGS = [
  {id:'push', name:'Push Day', emoji:'🔥', custom:false, exercises:[
    {id:'cp', name:'Chest press machine', sets:4, repsGoal:8},
    {id:'ip', name:'Incline chest press', sets:3, repsGoal:10},
    {id:'sp', name:'Shoulder press machine', sets:3, repsGoal:10},
    {id:'lr', name:'Lateral raise machine', sets:4, repsGoal:12},
    {id:'te', name:'Triceps extension machine', sets:3, repsGoal:12},
  ]},
  {id:'pull', name:'Pull Day', emoji:'💪', custom:false, exercises:[
    {id:'dl', name:'Barbell deadlift', sets:4, repsGoal:5},
    {id:'lp', name:'Lat pulldown', sets:3, repsGoal:10},
    {id:'sr', name:'Seated row machine', sets:3, repsGoal:10},
    {id:'rd', name:'Rear delt / reverse fly machine', sets:3, repsGoal:15},
    {id:'bc', name:'Biceps curl machine', sets:3, repsGoal:12},
  ]},
  {id:'legs', name:'Leg Day', emoji:'🦵', custom:false, exercises:[
    {id:'sq', name:'Barbell squat', sets:4, repsGoal:8},
    {id:'lph', name:'Leg press (horizontaal)', sets:3, repsGoal:10},
    {id:'le', name:'Leg extension', sets:3, repsGoal:12},
    {id:'slc', name:'Seated leg curl', sets:3, repsGoal:12},
    {id:'crs', name:'Calf raise (seated)', sets:4, repsGoal:15},
  ]},
];

/* ══════════════════════════════════════
   STORAGE
══════════════════════════════════════ */
const LS = {
  get: (k, d) => { try { const v = localStorage.getItem(k); return v != null ? JSON.parse(v) : d; } catch { return d; } },
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
};
const getUser = () => localStorage.getItem('bf_user');
const setUser = n => {
  localStorage.setItem('bf_user', n);
  syncToFirestore({ name: n });
};
const getPRs = () => LS.get('bf_prs', {});
const setPRs = v => { LS.set('bf_prs', v); syncToFirestore({ prs: v }); };
const getHist = () => LS.get('bf_hist', []);
const pushHist = s => {
  const h = getHist(); h.unshift(s);
  const trimmed = h.slice(0, 20);
  LS.set('bf_hist', trimmed);
  syncToFirestore({ history: trimmed });
};
const getProgs = () => LS.get('bf_progs', DEFAULT_PROGS);
const setProgs = v => { LS.set('bf_progs', v); syncToFirestore({ programs: v }); };
const getCustomM = () => LS.get('bf_cm', []);
const setCustomM = v => { LS.set('bf_cm', v); syncToFirestore({ customMachines: v }); };

// ── SETTINGS ──
const SETTINGS_DEFAULT = { restDuration: 90, notificationsOn: false, avatarEmoji: '💪' };
function getSettings() { return LS.get('bf_settings', SETTINGS_DEFAULT); }
function saveSettings(s) { LS.set('bf_settings', s); syncToFirestore({ settings: s }); }
function getSetting(key) { return getSettings()[key] ?? SETTINGS_DEFAULT[key]; }

/* ── Debounced Firestore sync ── */
let _syncTimer = null;
let _pendingSync = {};
function syncToFirestore(partial) {
  if (!window._fbUid || !window._fbSaveUserData) return;
  _pendingSync = { ..._pendingSync, ...partial };
  if (_syncTimer) clearTimeout(_syncTimer);
  _syncTimer = setTimeout(async () => {
    const data = { ..._pendingSync };
    _pendingSync = {};
    _syncTimer = null;
    await window._fbSaveUserData(window._fbUid, data);
  }, 1500); // batch writes, max 1.5s delay
}

/* ══════════════════════════════════════
   STATE
══════════════════════════════════════ */
let selProgId = null;
let workout = null;   // {prog, isOpen, sets:[{id,name,repsGoal,sets:[{weight,reps,done}]}]}
let ed = { name: '', emoji: '💪', exercises: [] };

/* ══════════════════════════════════════
   INIT — called by Firebase onAuthStateChanged
══════════════════════════════════════ */
function appInit() {
  showScr('home');
  renderHome();
}

// Legacy saveUser (not used with Firebase auth, kept for safety)
function saveUser() {}

// Auth tab switcher
function authSwitchTab(tab) {
  ['login','register'].forEach(t => {
    document.getElementById('tab-' + t).classList.toggle('active', t === tab);
    document.getElementById('panel-' + t).classList.toggle('active', t === tab);
  });
}

/* ══════════════════════════════════════
   NAVIGATION
══════════════════════════════════════ */
function showScr(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('scr-' + id);
  if (el) el.classList.add('active');
}

function goTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  showScr(tab);
  const body = document.querySelector('#scr-' + tab + ' .scroll-body');
  if (body) { body.style.animation = 'none'; requestAnimationFrame(() => { body.style.animation = 'screenSlideIn .3s cubic-bezier(.22,.68,0,1.1) forwards'; }); }
  if (tab === 'home') { if (quoteTimer) clearInterval(quoteTimer); renderHome(); }
  if (tab === 'history') renderHistory();
  if (tab === 'editor') renderEditor();
}

/* ══════════════════════════════════════
   HOME
══════════════════════════════════════ */
function renderHome() {
  const user = getUser();
  const h = new Date().getHours();
  const g = h < 12 ? 'Goedemorgen' : h < 18 ? 'Goedemiddag' : 'Goedenavond';
  document.getElementById('home-greet').textContent = `${g}, ${esc(user)} 👋`;

  const progs = getProgs();
  if (!selProgId || !progs.find(p => p.id === selProgId)) selProgId = progs[0]?.id || null;

  const body = document.getElementById('home-body');
  body.innerHTML = `
    <div class="greet-card su">
      <div style="display:flex;align-items:center;gap:14px">
        <div style="width:52px;height:52px;border-radius:15px;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0">${getSetting('avatarEmoji')}</div>
        <div>
          <div class="greet-name">Hey, ${esc(user)}!</div>
          <div class="greet-sub" id="greet-sub">${QUOTES[quoteIdx]}</div>
        </div>
      </div>
    </div>
    <span class="slbl">Kies je training</span>
    <div class="prog-list" id="prog-list"></div>
    <div class="btn-row">
      <button class="btn-outline" onclick="goTab('editor')">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        Nieuw schema
      </button>
      <button class="btn-outline" onclick="startOpen()">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        Open training
      </button>
    </div>
    <button class="btn-start" onclick="startWorkout()">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Training starten
    </button>
  `;

  const list = document.getElementById('prog-list');
  progs.forEach(p => {
    const div = document.createElement('div');
    div.className = 'prog-card su' + (p.id === selProgId ? ' sel' : '') + (p.custom ? ' custom-prog' : '');
    div.dataset.pid = p.id;
    div.innerHTML = `
      <div class="prog-emoji">${p.emoji}</div>
      <div class="prog-info">
        <div class="prog-name">${esc(p.name)}</div>
        <div class="prog-meta">${p.exercises.length} oefeningen${p.custom ? ' · Eigen schema' : ''}</div>
      </div>
      <div class="prog-actions">
        ${p.custom ? `<button class="icon-btn" onclick="delProg('${p.id}',event)" title="Verwijder">
          <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        </button>` : ''}
      </div>`;
    div.addEventListener('click', e => { if (e.target.closest('.icon-btn')) return; selProg(p.id); });
    list.appendChild(div);
  });
  // Start cycling quotes and attach ripples after DOM is ready
  requestAnimationFrame(() => {
    startQuoteCycle();
    attachRipples();
  });
}

function selProg(id) {
  selProgId = id;
  document.querySelectorAll('.prog-card').forEach(c => {
    c.classList.toggle('sel', c.dataset.pid === id);
  });
}

function delProg(id, e) {
  e.stopPropagation();
  if (!confirm('Schema verwijderen?')) return;
  const progs = getProgs().filter(p => p.id !== id);
  setProgs(progs);
  if (selProgId === id) selProgId = progs[0]?.id || null;
  renderHome();
  toast('Schema verwijderd');
}

/* ══════════════════════════════════════
   WORKOUT — PRESET
══════════════════════════════════════ */
function startWorkout() {
  const prog = getProgs().find(p => p.id === selProgId);
  if (!prog) { toast('Selecteer een schema'); return; }
  workout = {
    prog,
    isOpen: false,
    sets: prog.exercises.map(ex => ({
      ...ex,
      sets: Array.from({ length: ex.sets }, () => ({ weight: 0, reps: 0, done: false }))
    }))
  };
  renderWorkout();
  showScr('workout');
  requestWakeLock();
}

/* ══════════════════════════════════════
   WORKOUT — OPEN
══════════════════════════════════════ */
function startOpen() {
  workout = {
    prog: { id: 'open', name: 'Open Training', emoji: '⚡' },
    isOpen: true,
    sets: []
  };
  renderWorkout();
  showScr('workout');
  requestWakeLock();
}

function addOpenExercise() {
  const sel = document.getElementById('open-msel');
  const setsN = parseInt(document.getElementById('open-sets').value) || 3;
  const name = sel.value.trim();
  if (!name) { toast('Kies een oefening'); return; }
  const id = 'oe_' + Date.now();
  workout.sets.push({
    id, name,
    repsGoal: 10,
    sets: Array.from({ length: setsN }, () => ({ weight: 0, reps: 0, done: false }))
  });
  renderWorkout();
  // scroll to bottom
  setTimeout(() => {
    const body = document.getElementById('wk-body');
    body.scrollTop = body.scrollHeight;
  }, 50);
}

function removeOpenExercise(ei) {
  workout.sets.splice(ei, 1);
  renderWorkout();
}

/* ══════════════════════════════════════
   WORKOUT RENDER
══════════════════════════════════════ */
function renderWorkout() {
  if (!workout) return;
  const { prog, sets, isOpen } = workout;
  document.getElementById('wk-title').textContent = prog.name;

  const prs = getPRs();
  const totalSets = sets.reduce((s, ex) => s + ex.sets.length, 0);
  const doneSets = sets.reduce((s, ex) => s + ex.sets.filter(st => st.done).length, 0);
  const pct = totalSets ? doneSets / totalSets : 0;
  const C = 2 * Math.PI * 22;

  const totalVol = sets.reduce((s, ex) => s + ex.sets.filter(st => st.done).reduce((a, st) => a + (parseFloat(st.weight)||0)*(parseInt(st.reps)||0), 0), 0);
  const doneEx = sets.filter(ex => ex.sets.every(s => s.done) && ex.sets.length > 0).length;

  let html = `<div class="wk-hd su">
    <div class="wk-left">
      <div class="wk-day">${esc(prog.emoji)} ${esc(prog.name)}</div>
      <div class="wk-date">${new Date().toLocaleDateString('nl-NL', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
    </div>
    <div class="ring">
      <svg width="52" height="52" viewBox="0 0 52 52">
        <circle class="ring-t" cx="26" cy="26" r="22"/>
        <circle class="ring-f" cx="26" cy="26" r="22" stroke-dasharray="${C.toFixed(1)}" stroke-dashoffset="${(C * (1 - pct)).toFixed(1)}"/>
      </svg>
      <div class="ring-txt">${doneSets}/${totalSets}</div>
    </div>
  </div>
  <div class="wk-stats su">
    <div class="wk-stat">
      <div class="wk-stat-val" id="stat-vol">${totalVol > 0 ? (totalVol >= 1000 ? (totalVol/1000).toFixed(1)+'t' : totalVol+'kg') : '—'}</div>
      <div class="wk-stat-lbl">Volume</div>
    </div>
    <div class="wk-stat">
      <div class="wk-stat-val" id="stat-sets">${doneSets}</div>
      <div class="wk-stat-lbl">Sets klaar</div>
    </div>
    <div class="wk-stat">
      <div class="wk-stat-val" id="stat-ex">${doneEx}/${sets.length}</div>
      <div class="wk-stat-lbl">Oefeningen</div>
    </div>
  </div>`;

  sets.forEach((ex, ei) => {
    const pk = ex.id || ex.name;
    const pr = prs[pk] || { weight: 0, reps: 0 };
    const hasPR = ex.sets.some(s => s.done && isPR(s, pr));
    const allDone = ex.sets.length > 0 && ex.sets.every(s => s.done);
    const delay = (ei * 0.06 + 0.1).toFixed(2);

    html += `<div class="ex-card su${allDone ? ' all-done' : ''}" id="exc-${ei}" style="animation-delay:${delay}s">
      <div class="ex-head">
        <div style="flex:1;min-width:0">
          <div class="ex-name">${esc(ex.name)}</div>
          <div class="ex-sub">${ex.sets.length} sets${ex.repsGoal ? ` · doel: ${ex.repsGoal} reps` : ''}</div>
        </div>
        <div style="display:flex;align-items:flex-start;gap:6px">
          <div class="pr-badge${hasPR ? ' show' : ''}" id="prb-${ei}">🏆 PR!</div>
          ${isOpen ? `<button class="icon-btn" onclick="removeOpenExercise(${ei})" style="margin-top:2px"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>` : ''}
        </div>
      </div>
      <div class="set-rows" id="sets-${ei}">`;

    ex.sets.forEach((st, si) => {
      html += renderSetRow(ei, si, st, ex.sets.length);
    });

    html += `</div>
    <div style="padding:0 14px 0">
      <button class="btn-add-set" onclick="addSet(${ei})">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        Set toevoegen
      </button>
    </div>`;
    if (pr.weight > 0) html += `<div class="prev-rec">📊 Vorige PR: <b>${pr.weight} kg × ${pr.reps}</b></div>`;
    html += `</div>`;
  });

  // Open training: add exercise panel
  if (isOpen) {
    html += `<div class="add-ex-panel su">
      <div class="add-ex-title">➕ Oefening toevoegen</div>
      <div class="add-ex-row" style="flex-direction:column;gap:8px">
        <select class="msel" id="open-msel" style="width:100%">${buildMachineOpts()}</select>
        <div style="display:flex;gap:8px;align-items:stretch">
          <select class="sets-sel" id="open-sets" style="flex:1">
            ${[1,2,3,4,5,6].map(n => `<option value="${n}"${n===3?' selected':''}>${n} sets</option>`).join('')}
          </select>
          <button class="btn-add" onclick="addOpenExercise()" style="flex:2">Voeg toe</button>
        </div>
      </div>
    </div>`;
  }

  html += `<div class="wk-actions">
    <button class="btn-finish" onclick="finishWorkout()">
      <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
      Training afronden
    </button>
    <button class="btn-outline" onclick="openShareFromWorkout()" style="margin-top:0;width:100%">
      <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
      Workout delen
    </button>
    <button class="btn-danger" onclick="cancelWorkout()">Training annuleren</button>
  </div>`;

  document.getElementById('wk-body').innerHTML = html;
  // Attach stepper events
  sets.forEach((ex, ei) => {
    ex.sets.forEach((st, si) => attachSteppers(ei, si));
  });
  attachRipples();
}

function buildWeightOpts(cur) {
  const vals = [];
  for (let i = 0; i <= 300; i += 5) vals.push(i);
  // also add 2.5kg increments near 0
  const fine = [0,2.5,5,7.5,10,12.5,15,17.5,20,22.5,25,27.5,30,32.5,35,37.5,40,42.5,45,47.5,50,52.5,55,57.5,60,62.5,65,67.5,70,72.5,75,77.5,80,82.5,85,87.5,90,92.5,95,97.5,100,105,110,115,120,125,130,135,140,150,160,170,180,200,220,250,300];
  const unique = [...new Set([...fine])].sort((a,b)=>a-b);
  return unique.map(v => `<option value="${v}"${parseFloat(cur)===v?' selected':''}>${v % 1 === 0 ? v : v.toFixed(1)}</option>`).join('');
}
function buildRepsOpts(cur) {
  return Array.from({length:51},(_,i)=>i).map(v=>`<option value="${v}"${parseInt(cur)===v?' selected':''}>${v}</option>`).join('');
}

function renderSetRow(ei, si, st, totalSets) {
  const canRemove = totalSets === undefined ? true : totalSets > 1;
  return `<div class="set-row" id="row-${ei}-${si}">
    <div class="set-num">S${si + 1}</div>
    <div class="set-dd-wrap${st.done ? ' active-field' : ''}" id="sw-${ei}-${si}">
      <select class="set-dd" id="wv-${ei}-${si}" onchange="setWeight(${ei},${si},this.value)">
        ${buildWeightOpts(st.weight)}
      </select>
      <span class="set-dd-unit">kg</span>
    </div>
    <div class="set-dd-wrap${st.done ? ' active-field' : ''}" id="sr-${ei}-${si}">
      <select class="set-dd" id="rv-${ei}-${si}" onchange="setReps(${ei},${si},this.value)">
        ${buildRepsOpts(st.reps)}
      </select>
      <span class="set-dd-unit">reps</span>
    </div>
    <button class="set-ck${st.done ? ' done' : ''}" id="ck-${ei}-${si}" onclick="toggleSet(${ei},${si})">
      <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
    </button>
    ${canRemove ? `<button class="btn-rm-set" onclick="removeSet(${ei},${si})" title="Set verwijderen"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>` : '<div style="width:30px"></div>'}
  </div>`;
}

/* ══════════════════════════════════════
   ADD / REMOVE SET
══════════════════════════════════════ */
function addSet(ei) {
  if (!workout) return;
  const ex = workout.sets[ei];
  const last = ex.sets[ex.sets.length - 1] || { weight: 0, reps: 0 };
  ex.sets.push({ weight: last.weight, reps: last.reps, done: false });
  const si = ex.sets.length - 1;
  const st = ex.sets[si];
  const container = document.getElementById('sets-' + ei);
  if (container) {
    const tmp = document.createElement('div');
    tmp.innerHTML = renderSetRow(ei, si, st, ex.sets.length);
    container.appendChild(tmp.firstElementChild);
    // Update set numbers and remove-button visibility
    refreshSetRows(ei);
    // Update subtitle
    const sub = document.querySelector('#exc-' + ei + ' .ex-sub');
    if (sub) sub.textContent = ex.sets.length + ' sets' + (ex.repsGoal ? ' · doel: ' + ex.repsGoal + ' reps' : '');
    updateTotals();
    // Scroll to new row
    container.lastElementChild?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    toast('Set ' + (si + 1) + ' toegevoegd 💪');
  }
}

function removeSet(ei, si) {
  if (!workout) return;
  const ex = workout.sets[ei];
  if (ex.sets.length <= 1) { toast('Minimaal 1 set vereist'); return; }
  ex.sets.splice(si, 1);
  // Full re-render of the set rows only
  const container = document.getElementById('sets-' + ei);
  if (container) {
    container.innerHTML = ex.sets.map((st, i) => renderSetRow(ei, i, st, ex.sets.length)).join('');
    const sub = document.querySelector('#exc-' + ei + ' .ex-sub');
    if (sub) sub.textContent = ex.sets.length + ' sets' + (ex.repsGoal ? ' · doel: ' + ex.repsGoal + ' reps' : '');
    updateTotals();
  }
}

function refreshSetRows(ei) {
  if (!workout) return;
  const ex = workout.sets[ei];
  const container = document.getElementById('sets-' + ei);
  if (!container) return;
  // Update set number labels and remove button visibility
  container.querySelectorAll('.set-row').forEach((row, si) => {
    const numEl = row.querySelector('.set-num');
    if (numEl) numEl.textContent = 'S' + (si + 1);
    // Show/hide remove buttons based on count
    const rmBtn = row.querySelector('.btn-rm-set');
    if (rmBtn) rmBtn.style.display = ex.sets.length > 1 ? 'flex' : 'none';
    if (!rmBtn && ex.sets.length > 1) {
      // If no rm button exists but should, re-render
      container.innerHTML = ex.sets.map((st, i) => renderSetRow(ei, i, st, ex.sets.length)).join('');
    }
  });
}

function updateTotals() {
  if (!workout) return;
  const totalSets = workout.sets.reduce((s, ex) => s + ex.sets.length, 0);
  const doneSets = workout.sets.reduce((s, ex) => s + ex.sets.filter(s2 => s2.done).length, 0);
  const C = 2 * Math.PI * 22;
  const pct = totalSets ? doneSets / totalSets : 0;
  const rf = document.querySelector('.ring-f');
  if (rf) rf.setAttribute('stroke-dashoffset', (C * (1 - pct)).toFixed(1));
  const rt = document.querySelector('.ring-txt');
  if (rt) rt.textContent = doneSets + '/' + totalSets;
  const totalVol = workout.sets.reduce((s, ex) => s + ex.sets.filter(st => st.done).reduce((a, st) => a + (parseFloat(st.weight)||0)*(parseInt(st.reps)||0), 0), 0);
  const sv = document.getElementById('stat-vol');
  if (sv) sv.textContent = totalVol > 0 ? (totalVol >= 1000 ? (totalVol/1000).toFixed(1)+'t' : totalVol+'kg') : '—';
  const ss = document.getElementById('stat-sets');
  if (ss) ss.textContent = doneSets;
  const doneEx = workout.sets.filter(ex => ex.sets.every(s => s.done) && ex.sets.length > 0).length;
  const se = document.getElementById('stat-ex');
  if (se) se.textContent = doneEx + '/' + workout.sets.length;
}


function setWeight(ei, si, val) {
  if (!workout) return;
  workout.sets[ei].sets[si].weight = parseFloat(val) || 0;
  updatePRBadge(ei);
}
function setReps(ei, si, val) {
  if (!workout) return;
  workout.sets[ei].sets[si].reps = parseInt(val) || 0;
  updatePRBadge(ei);
}

/* ══════════════════════════════════════
   STEPPER LOGIC (replaced by dropdowns — kept for compatibility)
══════════════════════════════════════ */
function attachSteppers(ei, si) {
  // Dropdowns handle value changes via onchange; no steppers needed
}

function setupStepBtn(btn, ei, si, field, dir) {
  // No-op: steppers replaced by dropdowns
}

function updatePRBadge(ei) {
  if (!workout) return;
  const prs = getPRs();
  const ex = workout.sets[ei];
  const pk = ex.id || ex.name;
  const pr = prs[pk] || { weight: 0, reps: 0 };
  const hasPR = ex.sets.some(s => s.done && isPR(s, pr));
  const badge = document.getElementById('prb-' + ei);
  if (badge) badge.classList.toggle('show', hasPR);
}

function isPR(st, pr) {
  const w = parseFloat(st.weight) || 0;
  const r = parseInt(st.reps) || 0;
  return w > pr.weight || (w === pr.weight && r > pr.reps);
}

function toggleSet(ei, si) {
  if (!workout) return;
  const st = workout.sets[ei].sets[si];
  if (!st.weight && !st.reps) { toast('Stel gewicht of reps in'); return; }
  st.done = !st.done;

  // Update just this row without full re-render
  const ck = document.getElementById('ck-' + ei + '-' + si);
  if (ck) {
    ck.classList.toggle('done', st.done);
    if (st.done) {
      ck.classList.add('popping');
      ck.addEventListener('animationend', () => ck.classList.remove('popping'), { once: true });
    }
  }
  const sw = document.getElementById('sw-' + ei + '-' + si);
  if (sw) sw.classList.toggle('active-field', st.done);
  const sr = document.getElementById('sr-' + ei + '-' + si);
  if (sr) sr.classList.toggle('active-field', st.done);

  // Update card fade
  const card = document.getElementById('exc-' + ei);
  const allDone = workout.sets[ei].sets.every(s => s.done);
  if (card) card.classList.toggle('all-done', allDone);

  // Update ring
  const totalSets = workout.sets.reduce((s, ex) => s + ex.sets.length, 0);
  const doneSets = workout.sets.reduce((s, ex) => s + ex.sets.filter(s2 => s2.done).length, 0);
  const C = 2 * Math.PI * 22;
  const pct = totalSets ? doneSets / totalSets : 0;
  const rf = document.querySelector('.ring-f');
  if (rf) rf.setAttribute('stroke-dashoffset', (C * (1 - pct)).toFixed(1));
  const rt = document.querySelector('.ring-txt');
  if (rt) rt.textContent = doneSets + '/' + totalSets;
  const ringEl = document.querySelector('.ring');
  if (ringEl) ringEl.classList.toggle('complete', pct >= 1);

  updatePRBadge(ei);

  // Update mini stats
  const totalVolNew = workout.sets.reduce((s, ex) => s + ex.sets.filter(st2 => st2.done).reduce((a, st3) => a + (parseFloat(st3.weight)||0)*(parseInt(st3.reps)||0), 0), 0);
  const doneExNew = workout.sets.filter(ex => ex.sets.every(s2 => s2.done) && ex.sets.length > 0).length;
  const sv = document.getElementById('stat-vol');
  const ss = document.getElementById('stat-sets');
  const se = document.getElementById('stat-ex');
  if (sv) { sv.textContent = totalVolNew > 0 ? (totalVolNew >= 1000 ? (totalVolNew/1000).toFixed(1)+'t' : totalVolNew+'kg') : '—'; sv.classList.remove('stat-pop'); requestAnimationFrame(()=>sv.classList.add('stat-pop')); }
  if (ss) { ss.textContent = doneSets; ss.classList.remove('stat-pop'); requestAnimationFrame(()=>ss.classList.add('stat-pop')); }
  if (se) { se.textContent = doneExNew + '/' + workout.sets.length; }

  // Start rest timer wanneer set afgerond wordt
  if (st.done) startRestTimer(getSetting('restDuration'));
}

function openShareFromWorkout() {
  if (!workout) return;
  // Maak een tijdelijke sessie van de huidige workout voor de share card
  const prs = getPRs();
  const exArr = [];
  workout.sets.forEach(ex => {
    const done = ex.sets.filter(s => s.done && (s.weight || s.reps));
    if (!done.length) return;
    let best = { weight: 0, reps: 0 };
    done.forEach(s => {
      const w = parseFloat(s.weight) || 0, r = parseInt(s.reps) || 0;
      if (w > best.weight || (w === best.weight && r > best.reps)) best = { weight: w, reps: r };
    });
    exArr.push({ name: ex.name, sets: done.length, bestWeight: best.weight, bestReps: best.reps });
  });
  const tempSession = { date: Date.now(), programName: workout.prog.name, exercises: exArr };
  openShare(tempSession);
}



/* ══════════════════════════════════════
   REST TIMER — timestamp-gebaseerd
   Werkt door de eindtijd op te slaan (Date.now + duur),
   zodat na terugkeren vanuit andere app de resterende
   tijd correct berekend wordt vanuit de klok.
══════════════════════════════════════ */
let restInterval = null;
let restEndTime = 0;
let restDurationTotal = 90;

function stopRestTimer() {
  if (restInterval) { clearInterval(restInterval); restInterval = null; }
  restEndTime = 0;
  LS.set('bf_restEnd', 0);
  if (notifTimeout) { clearTimeout(notifTimeout); notifTimeout = null; }
  const el = document.getElementById('rest-timer');
  if (el) el.classList.remove('show');
}

function startRestTimer(secs) {
  restDurationTotal = secs;
  restEndTime = Date.now() + secs * 1000;
  LS.set('bf_restEnd', restEndTime);
  LS.set('bf_restTotal', secs);

  const el = document.getElementById('rest-timer');
  const fill = document.getElementById('rest-timer-fill');
  const txt = document.getElementById('rest-timer-txt');
  if (!el) return;
  if (restInterval) clearInterval(restInterval);
  el.classList.add('show');

  scheduleRestNotification(secs);

  function tick() {
    const remain = Math.max(0, Math.ceil((restEndTime - Date.now()) / 1000));
    const m = Math.floor(remain / 60);
    const s = remain % 60;
    if (txt) txt.textContent = m + ':' + String(s).padStart(2, '0');
    if (fill) fill.style.width = ((remain / restDurationTotal) * 100) + '%';
    if (remain <= 0) {
      clearInterval(restInterval); restInterval = null;
      if (el) el.classList.remove('show');
      LS.set('bf_restEnd', 0);
      toast('✅ Rust voorbij — next set!');
      showInAppNotification('⏱ Rust voorbij!', 'Tijd voor je volgende set 💪');
    }
  }
  tick();
  restInterval = setInterval(tick, 500);
}

/* ══════════════════════════════════════
   PUSH NOTIFICATIONS
══════════════════════════════════════ */
let notifTimeout = null;

async function requestNotificationPermission() {
  if (!('Notification' in window)) return false;
  if (Notification.permission === 'granted') return true;
  if (Notification.permission === 'denied') return false;
  const result = await Notification.requestPermission();
  return result === 'granted';
}

function scheduleRestNotification(secs) {
  if (notifTimeout) { clearTimeout(notifTimeout); notifTimeout = null; }
  if (!getSetting('notificationsOn')) return;
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  notifTimeout = setTimeout(() => {
    try {
      new Notification('Basis Fit ⚡', {
        body: 'Rust voorbij! Tijd voor je volgende set 💪',
        tag: 'bf-rest-done',
        renotify: true,
      });
    } catch(e) { /* niet beschikbaar */ }
    notifTimeout = null;
  }, secs * 1000);
}

let inAppNotifTimeout = null;
function showInAppNotification(title, body) {
  let banner = document.getElementById('in-app-notif');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'in-app-notif';
    banner.style.cssText = [
      'position:fixed','top:calc(env(safe-area-inset-top,0px) + 68px)',
      'left:50%','transform:translateX(-50%) translateY(-160%)',
      'background:var(--navy)','color:#fff','border-radius:16px',
      'padding:12px 20px','box-shadow:0 8px 32px rgba(27,39,53,.45)',
      'z-index:810','display:flex','flex-direction:column','gap:3px',
      'max-width:calc(100vw - 32px)','transition:transform .4s cubic-bezier(.34,1.4,.64,1)',
      'pointer-events:none','text-align:center','min-width:180px'
    ].join(';');
    document.body.appendChild(banner);
  }
  banner.innerHTML = `<div style="font-weight:700;font-size:15px">${title}</div><div style="font-size:13px;opacity:.65">${body}</div>`;
  banner.style.transform = 'translateX(-50%) translateY(0)';
  if (inAppNotifTimeout) clearTimeout(inAppNotifTimeout);
  inAppNotifTimeout = setTimeout(() => {
    banner.style.transform = 'translateX(-50%) translateY(-160%)';
  }, 3500);
}



/* ══════════════════════════════════════
   FINISH / CANCEL
══════════════════════════════════════ */
function finishWorkout() {
  if (!workout) return;
  const prs = getPRs();
  const exArr = [];
  let newPRs = 0;

  workout.sets.forEach(ex => {
    const pk = ex.id || ex.name;
    const pr = prs[pk] || { weight: 0, reps: 0 };
    const done = ex.sets.filter(s => s.done && (s.weight || s.reps));
    if (!done.length) return;

    let best = { weight: 0, reps: 0 };
    done.forEach(s => {
      const w = parseFloat(s.weight) || 0, r = parseInt(s.reps) || 0;
      if (w > best.weight || (w === best.weight && r > best.reps)) best = { weight: w, reps: r };
    });

    if (best.weight > pr.weight || (best.weight === pr.weight && best.reps > pr.reps)) {
      prs[pk] = best; newPRs++;
    }
    exArr.push({ name: ex.name, sets: done.length, bestWeight: best.weight, bestReps: best.reps });
  });

  if (!exArr.length) { toast('Geen sets afgerond'); return; }
  setPRs(prs);
  const histEntry = { date: Date.now(), programName: workout.prog.name, exercises: exArr };
  pushHist(histEntry);
  const savedSession = histEntry;
  workout = null;
  stopRestTimer();
  releaseWakeLock();
  showScr('home');
  renderHome();

  if (newPRs > 0) {
    setTimeout(() => {
      toast(`🏆 ${newPRs} nieuwe PR${newPRs > 1 ? "'s" : ''}!`);
      launchConfetti();
      setTimeout(() => {
        if (confirm('Wil je je workout delen op social media?')) openShare(savedSession);
      }, 2500);
    }, 300);
  } else {
    setTimeout(() => {
      toast('✅ Sessie opgeslagen!');
      setTimeout(() => {
        if (confirm('Wil je je workout delen?')) openShare(savedSession);
      }, 1500);
    }, 300);
  }
}

function cancelWorkout() {
  if (!confirm('Training annuleren? Voortgang gaat verloren.')) return;
  workout = null;
  stopRestTimer();
  releaseWakeLock();
  showScr('home');
  renderHome();
}

/* ══════════════════════════════════════
   HISTORY
══════════════════════════════════════ */
function renderHistory() {
  const hist = getHist().slice(0, 10);
  const body = document.getElementById('hist-body');
  if (!hist.length) {
    body.innerHTML = `<div class="empty-state"><div class="empty-icon">📭</div><p>Nog geen sessies opgeslagen.<br>Doe je eerste training!</p></div>`;
    return;
  }
  body.innerHTML = hist.map((s, i) => `
    <div class="hist-card su" style="animation-delay:${(i*0.07).toFixed(2)}s">
      <div class="hist-hd">
        <div>
          <div class="hist-name">${esc(s.programName)}</div>
          <div class="hist-date">${new Date(s.date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
        </div>
        <button onclick='openShare(${JSON.stringify(s)})' style="background:var(--ag);border:1px solid rgba(74,144,217,.25);border-radius:10px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:5px;color:var(--accent);font-size:12px;font-weight:700;font-family:'DM Sans',sans-serif;flex-shrink:0">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
          Delen
        </button>
      </div>
      <div class="hist-items">
        ${s.exercises.map(ex => `
          <div class="hist-item">
            <div class="hist-iname">${esc(ex.name)}</div>
            <div class="hist-istat">${ex.bestWeight}kg × ${ex.bestReps} · ${ex.sets}×</div>
          </div>`).join('')}
      </div>
    </div>`).join('');
}

/* ══════════════════════════════════════
   EDITOR
══════════════════════════════════════ */
function renderEditor() {
  const EMOJIS = ['💪','🔥','🦵','⚡','🏋️','🎯','💥','🚀','🧠','🫁','🏃','🥊'];
  const progs = getProgs();

  document.getElementById('editor-body').innerHTML = `
    <span class="slbl">Nieuw schema</span>
    <div class="editor-block su">
      <h3>Naam & icoon</h3>
      <input class="inp-light" id="ed-name" type="text" placeholder="Bijv. Upper Body A" maxlength="30" value="${esc(ed.name)}" oninput="ed.name=this.value"/>
      <div class="emoji-row">${EMOJIS.map(e => `<div class="emoji-opt${e === ed.emoji ? ' picked' : ''}" onclick="pickEmoji('${e}',this)">${e}</div>`).join('')}</div>
    </div>

    <div class="editor-block su">
      <h3>Oefeningen (${ed.exercises.length})</h3>
      <div class="ex-builder">
        ${ed.exercises.length
          ? ed.exercises.map((ex, i) => `
            <div class="ex-build-row">
              <div class="ex-build-name">${esc(ex.name)}</div>
              <div class="ex-build-sets">${ex.sets}×</div>
              <button class="btn-rm" onclick="rmEx(${i})"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>`).join('')
          : `<div style="font-size:13px;color:var(--g400);text-align:center;padding:6px 0">Nog geen oefeningen toegevoegd</div>`
        }
      </div>
      <div class="add-row" style="flex-direction:column;gap:10px">
        <select class="msel" id="ed-mach" style="width:100%">${buildMachineOpts()}</select>
        <div style="display:flex;gap:10px">
          <select class="sets-sel" id="ed-sets" style="flex:1">
            ${[1,2,3,4,5,6].map(n => `<option value="${n}"${n===3?' selected':''}>${n} sets</option>`).join('')}
          </select>
          <button class="btn-add" onclick="addEx()" style="flex:2">+ Voeg toe</button>
        </div>
      </div>
      <div class="divider"></div>
      <div style="font-size:12px;color:var(--g600);font-weight:600;margin-bottom:8px">Eigen machine toevoegen:</div>
      <div class="cm-row">
        <input class="inp-light" id="ed-cm" type="text" placeholder="Machine naam…" style="flex:1;padding:11px 12px;font-size:14px"/>
        <button class="btn-add" onclick="addCM()" style="white-space:nowrap">Bewaar</button>
      </div>
    </div>

    <button class="btn-save su" onclick="saveProg()">✓ Schema opslaan</button>

    ${progs.length ? `
    <span class="slbl" style="margin-top:20px;display:block">Opgeslagen schema's</span>
    <div class="editor-block su">
      ${progs.map(p => `
        <div class="existing-prog-item">
          <div class="ep-name">${p.emoji} ${esc(p.name)}</div>
          ${p.custom
            ? `<button class="icon-btn" onclick="delProg('${p.id}',event)"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>`
            : `<span class="ep-badge">Standaard</span>`}
        </div>`).join('')}
    </div>` : ''}
    <div style="height:8px"></div>
  `;
}

function buildMachineOpts() {
  const cms = getCustomM();
  const groups = { ...MG };
  if (cms.length) groups['Eigen machines'] = cms;
  let html = '<option value="">Kies oefening…</option>';
  Object.entries(groups).forEach(([g, ms]) => {
    html += `<optgroup label="${g}">${ms.map(m => `<option value="${esc(m)}">${esc(m)}</option>`).join('')}</optgroup>`;
  });
  return html;
}

function pickEmoji(e, el) {
  ed.emoji = e;
  document.querySelectorAll('.emoji-opt').forEach(o => o.classList.remove('picked'));
  el.classList.add('picked');
}

function addEx() {
  const name = document.getElementById('ed-mach').value;
  const sets = parseInt(document.getElementById('ed-sets').value) || 3;
  if (!name) { toast('Kies een oefening'); return; }
  ed.exercises.push({ id: 'e' + Date.now(), name, sets, repsGoal: 10 });
  renderEditor();
}

function rmEx(i) {
  ed.exercises.splice(i, 1);
  renderEditor();
}

function addCM() {
  const inp = document.getElementById('ed-cm');
  const name = inp.value.trim();
  if (!name) { toast('Vul een naam in'); return; }
  const cms = getCustomM();
  if (cms.includes(name)) { toast('Al opgeslagen'); return; }
  cms.push(name);
  setCustomM(cms);
  inp.value = '';
  renderEditor();
  toast('✅ Machine opgeslagen!');
}

function saveProg() {
  ed.name = document.getElementById('ed-name').value.trim();
  if (!ed.name) { toast('Geef je schema een naam'); return; }
  if (!ed.exercises.length) { toast('Voeg minstens 1 oefening toe'); return; }
  const progs = getProgs();
  progs.push({ id: 'cp_' + Date.now(), name: ed.name, emoji: ed.emoji, custom: true, exercises: ed.exercises });
  setProgs(progs);
  selProgId = progs[progs.length - 1].id;
  ed = { name: '', emoji: '💪', exercises: [] };
  renderEditor();
  toast('✅ Schema opgeslagen!');
}

/* ══════════════════════════════════════
   CONFETTI
══════════════════════════════════════ */
function launchConfetti() {
  const cv = document.getElementById('confetti-cv');
  const cx = cv.getContext('2d');
  cv.width = window.innerWidth; cv.height = window.innerHeight;
  const COLS = ['#4A90D9','#F5A623','#27C47A','#E8453C','#9B59B6','#F39C12','#1abc9c','#fff'];
  const ps = Array.from({ length: 130 }, () => ({
    x: Math.random() * cv.width, y: -20,
    w: Math.random() * 9 + 5, h: Math.random() * 5 + 3,
    col: COLS[Math.floor(Math.random() * COLS.length)],
    vx: (Math.random() - .5) * 6, vy: Math.random() * 5 + 2,
    rot: Math.random() * 360, vr: (Math.random() - .5) * 10,
  }));
  let t0 = null;
  (function frame(ts) {
    if (!t0) t0 = ts;
    const t = (ts - t0) / 1000;
    cx.clearRect(0, 0, cv.width, cv.height);
    ps.forEach(p => {
      p.x += p.vx; p.y += p.vy; p.vy += 0.08; p.rot += p.vr;
      cx.save();
      cx.globalAlpha = Math.max(0, 1 - (t - 1.5) / 1.5);
      cx.translate(p.x, p.y); cx.rotate(p.rot * Math.PI / 180);
      cx.fillStyle = p.col; cx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      cx.restore();
    });
    if (t < 3) requestAnimationFrame(frame);
    else cx.clearRect(0, 0, cv.width, cv.height);
  })(performance.now());
}

/* ══════════════════════════════════════
   TOAST
══════════════════════════════════════ */
let toastT = null;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  if (toastT) clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), 2800);
}

/* ══════════════════════════════════════
   HELPERS
══════════════════════════════════════ */
function esc(s) {
  return String(s)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

/* ══════════════════════════════════════
   BOOT — auth-state driven (Firebase calls appInit)
══════════════════════════════════════ */
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeNameModal(); });
document.getElementById('name-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeNameModal(); });
document.getElementById('inp-name-edit').addEventListener('keydown', e => { if (e.key === 'Enter') saveName(); });
// Auth form enter-key support
document.getElementById('inp-pw-login').addEventListener('keydown', e => { if (e.key === 'Enter') signInEmail(); });
document.getElementById('inp-pw-reg').addEventListener('keydown', e => { if (e.key === 'Enter') registerEmail(); });
// appInit is called by Firebase onAuthStateChanged (module script below)
</script>

<!-- ══════════════════════════════════════
     FIREBASE MODULE — moet LAST komen zodat
     de app-functies al gedefinieerd zijn
══════════════════════════════════════ -->
<script type="module">
import { initializeApp }             from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAnalytics }              from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js';
import {
  getAuth, onAuthStateChanged,
  GoogleAuthProvider, signInWithPopup,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  updateProfile, signOut
} from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp
} from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

/* ── Config ── */
const firebaseConfig = {
  apiKey:            'AIzaSyBp5hSusZ4LMPnMYkyTntmoJEJbwrBBrmo',
  authDomain:        'basis-fit.firebaseapp.com',
  projectId:         'basis-fit',
  storageBucket:     'basis-fit.firebasestorage.app',
  messagingSenderId: '480699904434',
  appId:             '1:480699904434:web:7329c713ecd8f00ad874ab',
  measurementId:     'G-8VD7BSDHQY'
};

const fbApp  = initializeApp(firebaseConfig);
const fbAuth = getAuth(fbApp);
const fbDb   = getFirestore(fbApp);
try { getAnalytics(fbApp); } catch(_) {}

/* ── Expose to global scope (app uses these) ── */
window._fbAuth = fbAuth;
window._fbDb   = fbDb;

/* ── Firestore helpers ── */
const userDoc = uid => doc(fbDb, 'users', uid);

window._fbLoadUserData = async (uid) => {
  try {
    const snap = await getDoc(userDoc(uid));
    return snap.exists() ? snap.data() : null;
  } catch(e) { console.warn('Firestore read failed:', e); return null; }
};

window._fbSaveUserData = async (uid, data) => {
  try {
    setSyncState('syncing');
    await setDoc(userDoc(uid), { ...data, updatedAt: serverTimestamp() }, { merge: true });
    setSyncState('synced');
  } catch(e) {
    setSyncState('idle');
    console.warn('Firestore write failed:', e);
  }
};

/* ── Auth actions (called by global onclick handlers) ── */
window.signInGoogle = async () => {
  setAuthLoading(true);
  try {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(fbAuth, provider);
    // onAuthStateChanged handles the rest
  } catch(e) {
    setAuthLoading(false);
    showAuthErr('login', authErrMsg(e.code));
  }
};

window.signInEmail = async () => {
  const email = document.getElementById('inp-email-login')?.value.trim();
  const pw    = document.getElementById('inp-pw-login')?.value;
  hideAuthErr('login');
  if (!email || !pw) { showAuthErr('login', 'Vul e-mail en wachtwoord in'); return; }
  setAuthLoading(true, 'btn-login');
  try {
    await signInWithEmailAndPassword(fbAuth, email, pw);
  } catch(e) {
    setAuthLoading(false, 'btn-login');
    showAuthErr('login', authErrMsg(e.code));
  }
};

window.registerEmail = async () => {
  const name  = document.getElementById('inp-name-reg')?.value.trim();
  const email = document.getElementById('inp-email-reg')?.value.trim();
  const pw    = document.getElementById('inp-pw-reg')?.value;
  hideAuthErr('register');
  if (!name)  { showAuthErr('register', 'Vul je naam in'); return; }
  if (!email) { showAuthErr('register', 'Vul een e-mailadres in'); return; }
  if (!pw || pw.length < 6) { showAuthErr('register', 'Wachtwoord minimaal 6 tekens'); return; }
  setAuthLoading(true, 'btn-register');
  try {
    const cred = await createUserWithEmailAndPassword(fbAuth, email, pw);
    await updateProfile(cred.user, { displayName: name });
    // onAuthStateChanged will fire with updated user
  } catch(e) {
    setAuthLoading(false, 'btn-register');
    showAuthErr('register', authErrMsg(e.code));
  }
};

window.signOutUser = async () => {
  if (!confirm('Uitloggen?')) return;
  await signOut(fbAuth);
  // onAuthStateChanged → null → show login
};

/* ── Auth helpers ── */
function setAuthLoading(on, btnId) {
  const btn = btnId ? document.getElementById(btnId) : null;
  if (btn) { btn.disabled = on; btn.textContent = on ? 'Laden…' : (btn.id === 'btn-login' ? 'Inloggen →' : 'Account aanmaken →'); }
}
function showAuthErr(panel, msg) {
  const el = document.getElementById('err-' + panel);
  if (el) { el.textContent = msg; el.classList.add('show'); }
}
function hideAuthErr(panel) {
  const el = document.getElementById('err-' + panel);
  if (el) el.classList.remove('show');
}
function authErrMsg(code) {
  const map = {
    'auth/email-already-in-use':   'Dit e-mailadres is al in gebruik',
    'auth/invalid-email':          'Ongeldig e-mailadres',
    'auth/weak-password':          'Wachtwoord is te zwak (min. 6 tekens)',
    'auth/user-not-found':         'Geen account gevonden met dit e-mailadres',
    'auth/wrong-password':         'Onjuist wachtwoord',
    'auth/invalid-credential':     'E-mail of wachtwoord klopt niet',
    'auth/too-many-requests':      'Te veel pogingen. Probeer later opnieuw',
    'auth/network-request-failed': 'Geen internetverbinding',
    'auth/popup-closed-by-user':   'Inlogvenster gesloten',
  };
  return map[code] || 'Er ging iets mis. Probeer opnieuw.';
}

/* ── Sync state indicator ── */
window.setSyncState = (state) => {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot';
  if (state === 'syncing') dot.classList.add('syncing');
  else if (state === 'synced') {
    dot.classList.add('synced');
    setTimeout(() => { if (dot) dot.classList.remove('synced'); }, 2000);
  }
};

/* ══════════════════════════════════════════════════════════════════════════════
   THEME MANAGEMENT
══════════════════════════════════════════════════════════════════════════════ */

// Initialize theme on page load
function initTheme() {
  const savedTheme = localStorage.getItem('bf_theme') || 'auto';
  applyTheme(savedTheme);
  updateThemeUI(savedTheme);
}

// Apply theme based on preference
function applyTheme(preference) {
  const root = document.documentElement;
  const themeMeta = document.getElementById('theme-color-meta');
  
  if (preference === 'auto') {
    // Use system preference
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    root.setAttribute('data-theme', isDark ? 'dark' : 'light');
    if (themeMeta) themeMeta.setAttribute('content', isDark ? '#0f1419' : '#1B2735');
  } else {
    root.setAttribute('data-theme', preference);
    if (themeMeta) themeMeta.setAttribute('content', preference === 'dark' ? '#0f1419' : '#1B2735');
  }
  
  updateThemeIcon();
}

// Update theme icon based on current theme
function updateThemeIcon() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const icons = document.querySelectorAll('#theme-icon');
  
  icons.forEach(icon => {
    if (currentTheme === 'dark') {
      // Moon icon for dark mode
      icon.innerHTML = '<path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>';
    } else {
      // Sun icon for light mode
      icon.innerHTML = '<path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1zm8 8a1 1 0 0 1-1 1h-1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1zM6 12a1 1 0 1 1 0-2H5a1 1 0 1 1 0 2h1zm-.2-6.8a1 1 0 0 1 0 1.4l-.7.7a1 1 0 0 1-1.4-1.4l.7-.7a1 1 0 0 1 1.4 0zm14.1 1.4a1 1 0 0 1-1.4 0l-.7-.7a1 1 0 0 1 1.4-1.4l.7.7a1 1 0 0 1 0 1.4zM12 18a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1zm7.1-1.9a1 1 0 0 1 0 1.4l-.7.7a1 1 0 1 1-1.4-1.4l.7-.7a1 1 0 0 1 1.4 0zM6.6 17.4a1 1 0 0 1-1.4 0l-.7-.7a1 1 0 0 1 1.4-1.4l.7.7a1 1 0 0 1 0 1.4z"/>';
    }
  });
}

// Update theme modal UI
function updateThemeUI(preference) {
  const options = document.querySelectorAll('.theme-option');
  options.forEach(opt => {
    if (opt.getAttribute('data-theme') === preference) {
      opt.classList.add('active');
    } else {
      opt.classList.remove('active');
    }
  });
}

// Open theme modal
window.openThemeModal = function() {
  const modal = document.getElementById('theme-modal');
  if (modal) modal.classList.add('show');
};

// Close theme modal
window.closeThemeModal = function() {
  const modal = document.getElementById('theme-modal');
  if (modal) modal.classList.remove('show');
};

// Select theme
window.selectTheme = function(theme) {
  localStorage.setItem('bf_theme', theme);
  applyTheme(theme);
  updateThemeUI(theme);
  closeThemeModal();
  
  // Sync to Firestore if logged in
  if (window._fbUid) {
    const settings = JSON.parse(localStorage.getItem('bf_settings') || '{}');
    settings.theme = theme;
    localStorage.setItem('bf_settings', JSON.stringify(settings));
    saveAppData();
  }
};

// Listen for system theme changes when in auto mode
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
  const savedTheme = localStorage.getItem('bf_theme') || 'auto';
  if (savedTheme === 'auto') {
    applyTheme('auto');
  }
});

// Initialize theme immediately
initTheme();


/* ── onAuthStateChanged — central app entry point ── */
onAuthStateChanged(fbAuth, async (user) => {
  if (user) {
    // Show loading while we fetch Firestore data
    showScr('loading');
    // Load remote data and merge with localStorage cache
    const remote = await window._fbLoadUserData(user.uid);
    if (remote) {
      // Merge remote into localStorage (remote wins)
      if (remote.name)          { localStorage.setItem('bf_user', remote.name); }
      if (remote.settings)      { localStorage.setItem('bf_settings', JSON.stringify(remote.settings)); }
      if (remote.prs)           { localStorage.setItem('bf_prs', JSON.stringify(remote.prs)); }
      if (remote.history)       { localStorage.setItem('bf_hist', JSON.stringify(remote.history)); }
      if (remote.programs)      { localStorage.setItem('bf_progs', JSON.stringify(remote.programs)); }
      if (remote.customMachines){ localStorage.setItem('bf_cm', JSON.stringify(remote.customMachines)); }
      
      // Load theme preference
      if (remote.settings && remote.settings.theme) {
        localStorage.setItem('bf_theme', remote.settings.theme);
        applyTheme(remote.settings.theme);
        updateThemeUI(remote.settings.theme);
      }
    } else {
      // First login: push displayName from Google/registration
      const displayName = user.displayName;
      if (displayName && !localStorage.getItem('bf_user')) {
        localStorage.setItem('bf_user', displayName);
      }
    }
    // Store UID for sync
    window._fbUid = user.uid;
    // Boot the app
    appInit();
  } else {
    // Logged out
    window._fbUid = null;
    // Clear cached data
    ['bf_user','bf_prs','bf_hist','bf_progs','bf_cm','bf_settings'].forEach(k => localStorage.removeItem(k));
    showScr('onboard');
  }
});
</script>

<!-- HTML2Canvas Library for capturing the canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// ══════════════════════════════════════════════════════════════════════════════
// SHARE EDITOR - Instagram Style
// ══════════════════════════════════════════════════════════════════════════════

let shareEditorState = {
  selectedElement: null,
  workoutData: {
    workout: 'Push Day',
    duration: '52 min',
    exercises: '8',
    pr: '120kg'
  },
  elementSettings: {
    workout: { font: 'syne', bg: 'solid', emoji: false, visible: true },
    duration: { font: 'syne', bg: 'solid', emoji: false, visible: true },
    exercises: { font: 'syne', bg: 'solid', emoji: false, visible: true },
    pr: { font: 'syne', bg: 'solid', emoji: false, visible: true }
  },
  bgImage: null
};

// Open Share Editor
window.openShareEditor = function(workoutData) {
  // Update workout data if provided
  if (workoutData) {
    shareEditorState.workoutData = { ...shareEditorState.workoutData, ...workoutData };
    
    // Update element text
    if (workoutData.workout) document.querySelector('#elem-workout .element-text').textContent = workoutData.workout;
    if (workoutData.duration) document.querySelector('#elem-duration .element-text').textContent = workoutData.duration;
    if (workoutData.exercises) document.querySelector('#elem-exercises .element-text').textContent = workoutData.exercises;
    if (workoutData.pr) document.querySelector('#elem-pr .element-text').textContent = workoutData.pr;
  }
  
  // Show editor
  const editor = document.getElementById('share-editor');
  editor.classList.add('open');
  
  // Initialize drag for all elements
  initializeDraggable();
  
  // Deselect all
  deselectAllElements();
};

// Close Share Editor
window.closeShareEditor = function() {
  const editor = document.getElementById('share-editor');
  editor.classList.remove('open');
  deselectAllElements();
};

// Initialize Draggable Elements
function initializeDraggable() {
  const elements = document.querySelectorAll('.draggable-element');
  
  elements.forEach(elem => {
    let isDragging = false;
    let startX, startY, initialX, initialY;
    
    const onStart = (e) => {
      // Select this element
      selectElement(elem);
      
      isDragging = true;
      elem.classList.add('dragging');
      
      const touch = e.type.includes('touch') ? e.touches[0] : e;
      startX = touch.clientX;
      startY = touch.clientY;
      
      const rect = elem.getBoundingClientRect();
      const parent = elem.parentElement.getBoundingClientRect();
      initialX = rect.left - parent.left;
      initialY = rect.top - parent.top;
    };
    
    const onMove = (e) => {
      if (!isDragging) return;
      e.preventDefault();
      
      const touch = e.type.includes('touch') ? e.touches[0] : e;
      const deltaX = touch.clientX - startX;
      const deltaY = touch.clientY - startY;
      
      const newX = initialX + deltaX;
      const newY = initialY + deltaY;
      
      // Constrain to canvas
      const parent = elem.parentElement.getBoundingClientRect();
      const elemRect = elem.getBoundingClientRect();
      
      const maxX = parent.width - elemRect.width;
      const maxY = parent.height - elemRect.height;
      
      const clampedX = Math.max(0, Math.min(newX, maxX));
      const clampedY = Math.max(0, Math.min(newY, maxY));
      
      elem.style.left = clampedX + 'px';
      elem.style.top = clampedY + 'px';
    };
    
    const onEnd = () => {
      isDragging = false;
      elem.classList.remove('dragging');
    };
    
    // Mouse events
    elem.addEventListener('mousedown', onStart);
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);
    
    // Touch events
    elem.addEventListener('touchstart', onStart, { passive: false });
    document.addEventListener('touchmove', onMove, { passive: false });
    document.addEventListener('touchend', onEnd);
  });
}

// Select Element
function selectElement(elem) {
  deselectAllElements();
  
  elem.classList.add('selected');
  shareEditorState.selectedElement = elem.dataset.stat;
  
  // Show relevant toolbars
  document.getElementById('font-section').style.display = 'flex';
  document.getElementById('bg-section').style.display = 'flex';
  document.getElementById('emoji-section').style.display = 'flex';
  
  // Update toolbar to reflect current settings
  updateToolbarState();
}

// Deselect All Elements
function deselectAllElements() {
  document.querySelectorAll('.draggable-element').forEach(el => {
    el.classList.remove('selected');
  });
  
  shareEditorState.selectedElement = null;
  
  // Hide element-specific toolbars
  document.getElementById('font-section').style.display = 'none';
  document.getElementById('bg-section').style.display = 'none';
  document.getElementById('emoji-section').style.display = 'none';
}

// Update Toolbar State
function updateToolbarState() {
  if (!shareEditorState.selectedElement) return;
  
  const settings = shareEditorState.elementSettings[shareEditorState.selectedElement];
  
  // Update font buttons
  document.querySelectorAll('#font-section .toolbar-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  const fontBtns = {
    'syne': 0, 'dm-sans': 1, 'dm-mono': 2, 'impact': 3, 'cursive': 4
  };
  const fontBtnIndex = fontBtns[settings.font];
  if (fontBtnIndex !== undefined) {
    document.querySelectorAll('#font-section .toolbar-btn')[fontBtnIndex]?.classList.add('active');
  }
  
  // Update bg buttons
  document.querySelectorAll('#bg-section .toolbar-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  const bgBtns = {
    'solid': 0, 'semi': 1, 'none': 2, 'dark': 3, 'dark-semi': 4
  };
  const bgBtnIndex = bgBtns[settings.bg];
  if (bgBtnIndex !== undefined) {
    document.querySelectorAll('#bg-section .toolbar-btn')[bgBtnIndex]?.classList.add('active');
  }
  
  // Update emoji button text
  document.getElementById('emoji-btn-text').textContent = settings.emoji ? 'Emoji verbergen' : 'Emoji toevoegen';
}

// Toggle Element Visibility
window.toggleElement = function(elemName) {
  const elem = document.getElementById(`elem-${elemName}`);
  const btn = document.querySelector(`.element-toggle-btn[data-element="${elemName}"]`);
  
  shareEditorState.elementSettings[elemName].visible = !shareEditorState.elementSettings[elemName].visible;
  
  if (shareEditorState.elementSettings[elemName].visible) {
    elem.style.display = 'block';
    btn.classList.add('active');
  } else {
    elem.style.display = 'none';
    btn.classList.remove('active');
    
    // Deselect if this was selected
    if (shareEditorState.selectedElement === elemName) {
      deselectAllElements();
    }
  }
};

// Set Font for Selected Element
window.setElementFont = function(font) {
  if (!shareEditorState.selectedElement) return;
  
  const elem = document.getElementById(`elem-${shareEditorState.selectedElement}`);
  
  // Remove all font classes
  elem.classList.remove('font-syne', 'font-dm-sans', 'font-dm-mono', 'font-impact', 'font-cursive');
  
  // Add new font class
  elem.classList.add(`font-${font}`);
  
  // Update state
  shareEditorState.elementSettings[shareEditorState.selectedElement].font = font;
  
  // Update toolbar
  updateToolbarState();
};

// Set Background for Selected Element
window.setElementBg = function(bgType) {
  if (!shareEditorState.selectedElement) return;
  
  const elem = document.getElementById(`elem-${shareEditorState.selectedElement}`);
  
  // Remove all bg classes
  elem.classList.remove('bg-none', 'bg-semi', 'bg-dark', 'bg-dark-semi');
  
  // Add new bg class (solid is default, no class needed)
  if (bgType !== 'solid') {
    elem.classList.add(`bg-${bgType}`);
  }
  
  // Update state
  shareEditorState.elementSettings[shareEditorState.selectedElement].bg = bgType;
  
  // Update toolbar
  updateToolbarState();
};

// Toggle Emoji
window.toggleEmoji = function() {
  if (!shareEditorState.selectedElement) return;
  
  const elem = document.getElementById(`elem-${shareEditorState.selectedElement}`);
  const emojiSpan = elem.querySelector('.element-emoji');
  
  shareEditorState.elementSettings[shareEditorState.selectedElement].emoji = 
    !shareEditorState.elementSettings[shareEditorState.selectedElement].emoji;
  
  if (shareEditorState.elementSettings[shareEditorState.selectedElement].emoji) {
    emojiSpan.style.display = 'inline';
    
    // Set default emojis if not set
    const emojis = { workout: '💪', duration: '⏱️', exercises: '🏋️', pr: '🔥' };
    if (!emojiSpan.textContent) {
      emojiSpan.textContent = emojis[shareEditorState.selectedElement];
    }
  } else {
    emojiSpan.style.display = 'none';
  }
  
  // Update toolbar
  updateToolbarState();
};

// Background Image
window.openBgImagePicker = function() {
  document.getElementById('bg-image-input').click();
};

window.handleBgImage = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(event) {
    const img = document.getElementById('share-bg-img');
    img.src = event.target.result;
    img.style.display = 'block';
    shareEditorState.bgImage = event.target.result;
    
    // Update button state
    document.querySelectorAll('.toolbar-section').forEach(section => {
      if (section.querySelector('.toolbar-label')?.textContent === 'Achtergrond') {
        section.querySelectorAll('.toolbar-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.includes('Afbeelding')) {
            btn.classList.add('active');
          }
        });
      }
    });
  };
  reader.readAsDataURL(file);
};

window.setBgType = function(type) {
  const img = document.getElementById('share-bg-img');
  
  if (type === 'gradient') {
    img.style.display = 'none';
    shareEditorState.bgImage = null;
  }
  
  // Update button states
  document.querySelectorAll('.toolbar-section').forEach(section => {
    if (section.querySelector('.toolbar-label')?.textContent === 'Achtergrond') {
      section.querySelectorAll('.toolbar-btn').forEach(btn => {
        btn.classList.remove('active');
        if ((type === 'gradient' && btn.textContent.includes('Gradient')) ||
            (type !== 'gradient' && btn.textContent.includes('Afbeelding'))) {
          btn.classList.add('active');
        }
      });
    }
  });
};

// Reset Layout
window.resetLayout = function() {
  // Reset positions
  document.getElementById('elem-workout').style.top = '60px';
  document.getElementById('elem-workout').style.left = '20px';
  document.getElementById('elem-duration').style.top = '180px';
  document.getElementById('elem-duration').style.left = '20px';
  document.getElementById('elem-exercises').style.top = '300px';
  document.getElementById('elem-exercises').style.left = '20px';
  document.getElementById('elem-pr').style.top = '420px';
  document.getElementById('elem-pr').style.left = '20px';
  
  // Reset all settings
  Object.keys(shareEditorState.elementSettings).forEach(key => {
    shareEditorState.elementSettings[key] = { font: 'syne', bg: 'solid', emoji: false, visible: true };
    
    const elem = document.getElementById(`elem-${key}`);
    elem.classList.remove('font-dm-sans', 'font-dm-mono', 'font-impact', 'font-cursive', 
                           'bg-none', 'bg-semi', 'bg-dark', 'bg-dark-semi');
    elem.classList.add('font-syne');
    elem.style.display = 'block';
    elem.querySelector('.element-emoji').style.display = 'none';
    
    document.querySelector(`.element-toggle-btn[data-element="${key}"]`)?.classList.add('active');
  });
  
  deselectAllElements();
  showToast('Layout gereset!');
};

// Download Share Image
window.downloadShareImage = async function() {
  const loading = document.getElementById('editor-loading');
  loading.classList.add('show');
  
  try {
    const canvas = await html2canvas(document.getElementById('share-canvas'), {
      backgroundColor: null,
      scale: 2,
      logging: false,
      useCORS: true,
      allowTaint: true
    });
    
    // Convert to blob and download
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `basis-fit-workout-${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(url);
      
      loading.classList.remove('show');
      showToast('✓ Afbeelding gedownload!');
    }, 'image/png');
  } catch(err) {
    console.error('Download error:', err);
    loading.classList.remove('show');
    showToast('Download mislukt');
  }
};

// Save and return to share sheet
window.saveShareImage = async function() {
  const loading = document.getElementById('editor-loading');
  loading.classList.add('show');
  
  try {
    const canvas = await html2canvas(document.getElementById('share-canvas'), {
      backgroundColor: null,
      scale: 2,
      logging: false,
      useCORS: true,
      allowTaint: true
    });
    
    // Store in state for sharing
    window.shareImageData = canvas.toDataURL('image/png');
    
    loading.classList.remove('show');
    closeShareEditor();
    
    // Open regular share sheet with the created image
    showToast('✓ Story opgeslagen!');
    
  } catch(err) {
    console.error('Save error:', err);
    loading.classList.remove('show');
    showToast('Opslaan mislukt');
  }
};

// Click canvas area to deselect
document.addEventListener('click', (e) => {
  if (e.target.closest('.share-canvas-container') && 
      !e.target.closest('.draggable-element') &&
      shareEditorState.selectedElement) {
    deselectAllElements();
  }
});
</script>
</body>
</html>
